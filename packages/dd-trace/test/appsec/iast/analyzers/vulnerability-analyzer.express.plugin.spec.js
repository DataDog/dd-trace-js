'use strict'

const fs = require('fs')
const os = require('os')
const path = require('path')

const { UNVALIDATED_REDIRECT } = require('../../../../src/appsec/iast/vulnerabilities')
const { prepareTestServerForIastInExpress } = require('../utils')
const { storage } = require('../../../../../datadog-core')
const iastContextFunctions = require('../../../../src/appsec/iast/iast-context')
const { newTaintedString } = require('../../../../src/appsec/iast/taint-tracking/operations')

describe('Vulnerability Analyzer plugin', () => {
  let redirectFunctions
  let redirectMinFunctions
  const redirectFunctionsFilename = 'redirect-express-functions.js'
  const redirectFunctionsPath = path.join(os.tmpdir(), redirectFunctionsFilename)

  const redirectFunctionsMinFilename = 'redirect-express-functions.min.js'
  const redirectFunctionsMinPath = path.join(os.tmpdir(), redirectFunctionsMinFilename)

  const redirectFunctionsMapFilename = 'redirect-express-functions.min.js.map'
  const redirectFunctionsMapPath = path.join(os.tmpdir(), redirectFunctionsMapFilename)

  before(() => {
    fs.copyFileSync(path.join(__dirname, 'resources', redirectFunctionsFilename), redirectFunctionsPath)

    // remove comment to adjust sourcemap and source file lines
    const fileContent = fs.readFileSync(path.join(__dirname, 'resources', redirectFunctionsMinFilename), 'utf8')
      .replace('/* eslint-disable */\n', '')
    fs.writeFileSync(redirectFunctionsMinPath, fileContent)
    fs.copyFileSync(path.join(__dirname, 'resources', redirectFunctionsMapFilename), redirectFunctionsMapPath)

    redirectFunctions = require(redirectFunctionsPath)
    redirectMinFunctions = require(redirectFunctionsMinPath)
  })

  after(() => {
    fs.unlinkSync(redirectFunctionsPath)
    fs.unlinkSync(redirectFunctionsMinPath)
    fs.unlinkSync(redirectFunctionsMapPath)
  })

  withVersions('express', 'express', version => {
    prepareTestServerForIastInExpress('should find original source line minified or not', version,
      (testThatRequestHasVulnerability, testThatRequestHasNoVulnerability) => {
        testThatRequestHasVulnerability((req, res) => {
          const store = storage.getStore()
          const iastCtx = iastContextFunctions.getIastContext(store)
          const location = newTaintedString(iastCtx, 'https://app.com?id=tron', 'param', 'Request')
          redirectMinFunctions.insecureWithResHeaderMethod('location', location, res)
        }, UNVALIDATED_REDIRECT, {
          occurrences: 1,
          location: {
            path: redirectFunctionsFilename, // original source code file indicated in sourceMappingURL
            line: 4 // line in not minified source file
          }
        })

        testThatRequestHasVulnerability((req, res) => {
          const store = storage.getStore()
          const iastCtx = iastContextFunctions.getIastContext(store)
          const location = newTaintedString(iastCtx, 'https://app.com?id=tron', 'param', 'Request')
          redirectFunctions.insecureWithResHeaderMethod('location', location, res)
        }, UNVALIDATED_REDIRECT, {
          occurrences: 1,
          location: {
            path: redirectFunctionsFilename,
            line: 4
          }
        })
      })
  })
})
