'use strict'

const { createVulnerability, addVulnerability, sendVulnerabilities, clearCache } =
  require('../../../src/appsec/iast/vulnerability-reporter')

describe('vulnerability-reporter', () => {
  beforeEach(() => {
    clearCache()
  })

  describe('createVulnerability', () => {
    it('invalid input does not break and creates null vulnerability', () => {
      expect(createVulnerability()).to.be.null
      expect(createVulnerability(null)).to.be.null
      expect(createVulnerability(undefined)).to.be.null
      expect(createVulnerability(null, null)).to.be.null
      expect(createVulnerability(null, undefined)).to.be.null
      expect(createVulnerability(null, null, null)).to.be.null
      expect(createVulnerability(null, null, undefined)).to.be.null
      expect(createVulnerability(null, null, undefined, null)).to.be.null
      expect(createVulnerability(null, null, undefined, undefined)).to.be.null
      expect(createVulnerability('WEAK_HASHING', null, undefined, undefined)).to.be.null
      expect(createVulnerability('WEAK_HASHING', {}, undefined, undefined)).to.be.null
      expect(createVulnerability('WEAK_HASHING', {}, undefined, {})).to.be.null
    })

    it('creates the object with all properties', () => {
      const type = 'WEAK_HASHING'
      const evidence = { value: 'md5' }
      const location = { path: 'file-name.js', line: 15 }
      const spanId = 888
      const vulnerability = createVulnerability(type, evidence, spanId, location)
      expect(vulnerability).not.to.be.null
      expect(vulnerability.type).to.be.equal(type)
      expect(vulnerability.evidence).to.be.equal(evidence)
      expect(vulnerability.location.path).to.be.equal(location.path)
      expect(vulnerability.location.line).to.be.equal(location.line)
      expect(vulnerability.location.spanId).to.be.equal(spanId)
    })

    it('creates the object without location', () => {
      const type = 'WEAK_HASHING'
      const evidence = { value: 'md5' }
      const spanId = 888
      const vulnerability = createVulnerability(type, evidence, spanId)
      expect(vulnerability).not.to.be.null
      expect(vulnerability.type).to.be.equal(type)
      expect(vulnerability.evidence).to.be.equal(evidence)
      expect(vulnerability.location.path).to.be.undefined
      expect(vulnerability.location.line).to.be.undefined
      expect(vulnerability.location.spanId).to.be.equal(spanId)
    })
  })

  describe('addVulnerability', () => {
    it('should not break with invalid input', () => {
      addVulnerability()
      addVulnerability(null, null)
      addVulnerability(undefined, undefined)
      addVulnerability(null, {})
      addVulnerability({}, null)
      addVulnerability({}, undefined)
      addVulnerability({})
    })

    it('should not add null vulnerability', () => {
      const iastContext = {}
      addVulnerability(iastContext, null)
      expect(iastContext).not.to.have.property('vulnerabilities')
      iastContext.vulnerabilities = []
      addVulnerability(iastContext, undefined)
      expect(iastContext.vulnerabilities).to.have.length(0)
    })

    it('should create vulnerability array if it does not exist', () => {
      const iastContext = {}
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'sha1' }, 888))
      expect(iastContext).to.have.property('vulnerabilities')
      expect(iastContext.vulnerabilities).to.be.an('array')
    })

    it('should add multiple vulnerabilities', () => {
      const iastContext = {}
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'sha1' }, -555))
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'sha1' }, 888))
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'sha1' }, 123))
      expect(iastContext.vulnerabilities).to.have.length(3)
    })

    it('should add in the context evidence properties', () => {
      const iastContext = {}
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'sha1' }, 888))
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'md5' },
        -123, { path: 'path.js', line: 12 }))
      expect(iastContext.vulnerabilities).to.have.length(2)
      expect(iastContext).to.have.nested.property('vulnerabilities.0.type', 'INSECURE_HASHING')
      expect(iastContext).to.have.nested.property('vulnerabilities.0.evidence.value', 'sha1')
      expect(iastContext).to.have.nested.property('vulnerabilities.0.location.spanId', 888)
      expect(iastContext).to.have.nested.property('vulnerabilities.1.type', 'INSECURE_HASHING')
      expect(iastContext).to.have.nested.property('vulnerabilities.1.evidence.value', 'md5')
      expect(iastContext).to.have.nested.property('vulnerabilities.1.location.spanId', -123)
      expect(iastContext).to.have.nested.property('vulnerabilities.1.location.path', 'path.js')
      expect(iastContext).to.have.nested.property('vulnerabilities.1.location.line', 12)
    })
  })

  describe('sendVulnerabilities', () => {
    let span

    beforeEach(() => {
      span = {
        addTags: sinon.stub()
      }
    })
    afterEach(() => {
      sinon.restore()
    })

    it('should not fail with invalid parameters', () => {
      sendVulnerabilities()
      sendVulnerabilities(null)
      sendVulnerabilities(undefined)
      sendVulnerabilities(-15)
      sendVulnerabilities({})
    })

    it('should not send vulnerability with empty context', () => {
      sendVulnerabilities({ rootSpan: span })
      expect(span.addTags).not.to.have.been.called
    })

    it('should not send invalid vulnerability', () => {
      sendVulnerabilities({ vulnerabilities: [{ invalid: 'vulnerability' }], rootSpan: span })
      expect(span.addTags).not.to.have.been.called
    })

    it('should send one with one vulnerability', () => {
      const iastContext = { rootSpan: span }
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'sha1' }, 888))
      sendVulnerabilities(iastContext)
      expect(span.addTags).to.have.been.calledOnceWithExactly({
        'manual.keep': 'true',
        '_dd.iast.json': '{"sources":[],"vulnerabilities":[{"type":"INSECURE_HASHING","hash":3254801297,' +
          '"evidence":{"value":"sha1"},"location":{"spanId":888}}]}'
      })
    })

    it('should send only valid vulnerabilities', () => {
      const iastContext = { rootSpan: span }
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'sha1' }, 888))
      iastContext.vulnerabilities.push({ invalid: 'vulnerability' })
      sendVulnerabilities(iastContext)
      expect(span.addTags).to.have.been.calledOnceWithExactly({
        'manual.keep': 'true',
        '_dd.iast.json': '{"sources":[],"vulnerabilities":[{"type":"INSECURE_HASHING","hash":3254801297,' +
          '"evidence":{"value":"sha1"},"location":{"spanId":888}}]}'
      })
    })

    it('should send vulnerabilities with evidence, ranges and sources', () => {
      const iastContext = { rootSpan: span }
      const evidence1 = {
        value: 'SELECT * FROM u WHERE name = \'joe\';',
        ranges: [
          {
            start: 30,
            end: 33,
            iinfo: {
              type: 'ORIGIN_TYPE_1',
              parameterName: 'PARAMETER_NAME_1',
              parameterValue: 'joe'
            }
          }
        ]
      }
      addVulnerability(
        iastContext,
        createVulnerability('SQL_INJECTION', evidence1, 888, { path: 'filename.js', line: 88 })
      )

      const evidence2 = {
        value: 'SELECT id FROM u WHERE email = \'joe@mail.com\';',
        ranges: [
          {
            start: 32,
            end: 44,
            iinfo: {
              type: 'ORIGIN_TYPE_2',
              parameterName: 'PARAMETER_NAME_2',
              parameterValue: 'joe@mail.com'
            }
          }
        ]
      }
      addVulnerability(
        iastContext,
        createVulnerability('SQL_INJECTION', evidence2, 888, { path: 'filename.js', line: 99 })
      )

      sendVulnerabilities(iastContext)
      expect(span.addTags).to.have.been.calledOnceWithExactly({
        'manual.keep': 'true',
        '_dd.iast.json': '{"sources":[{"origin":"ORIGIN_TYPE_1","name":"PARAMETER_NAME_1","value":"joe"},' +
          '{"origin":"ORIGIN_TYPE_2","name":"PARAMETER_NAME_2","value":"joe@mail.com"}],' +
          '"vulnerabilities":[{"type":"SQL_INJECTION","hash":4676753086,' +
          '"evidence":{"valueParts":[{"value":"SELECT * FROM u WHERE name = \'"},{"value":"joe","source":0},' +
          '{"value":"\';"}]},"location":{"spanId":888,"path":"filename.js","line":88}},' +
          '{"type":"SQL_INJECTION","hash":4676753118,"evidence":{"valueParts":' +
          '[{"value":"SELECT id FROM u WHERE email = \'"},{"value":"joe@mail.com","source":1},{"value":"\';"}]},' +
          '"location":{"spanId":888,"path":"filename.js","line":99}}]}'
      })
    })

    it('should send multiple vulnerabilities with same tainted source', () => {
      const iastContext = { rootSpan: span }
      const evidence1 = {
        value: 'SELECT * FROM u WHERE name = \'joe\';',
        ranges: [
          {
            start: 30,
            end: 33,
            iinfo: {
              type: 'ORIGIN_TYPE_1',
              parameterName: 'PARAMETER_NAME_1',
              parameterValue: 'joe'
            }
          }
        ]
      }
      addVulnerability(
        iastContext,
        createVulnerability('SQL_INJECTION', evidence1, 888, { path: 'filename.js', line: 88 })
      )

      const evidence2 = {
        value: 'UPDATE u SET name=\'joe\' WHERE id=1;',
        ranges: [
          {
            start: 19,
            end: 22,
            iinfo: {
              type: 'ORIGIN_TYPE_1',
              parameterName: 'PARAMETER_NAME_1',
              parameterValue: 'joe'
            }
          }
        ]
      }
      addVulnerability(
        iastContext,
        createVulnerability('SQL_INJECTION', evidence2, 888, { path: 'filename.js', line: 99 })
      )

      sendVulnerabilities(iastContext)
      expect(span.addTags).to.have.been.calledOnceWithExactly({
        'manual.keep': 'true',
        '_dd.iast.json': '{"sources":[{"origin":"ORIGIN_TYPE_1","name":"PARAMETER_NAME_1","value":"joe"}],' +
          '"vulnerabilities":[{"type":"SQL_INJECTION","hash":4676753086,' +
          '"evidence":{"valueParts":[{"value":"SELECT * FROM u WHERE name = \'"},{"value":"joe","source":0},' +
          '{"value":"\';"}]},"location":{"spanId":888,"path":"filename.js","line":88}},' +
          '{"type":"SQL_INJECTION","hash":4676753118,"evidence":{"valueParts":' +
          '[{"value":"UPDATE u SET name=\'"},{"value":"joe","source":0},{"value":"\' WHERE id=1;"}]},' +
          '"location":{"spanId":888,"path":"filename.js","line":99}}]}'
      })
    })

    it('should send once with multiple vulnerabilities', () => {
      const iastContext = { rootSpan: span }
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'sha1' }, 888,
        { path: '/path/to/file1.js', line: 1 }))
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'md5' }, 1,
        { path: '/path/to/file2.js', line: 1 }))
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'md5' }, -5,
        { path: '/path/to/file3.js', line: 3 }))
      sendVulnerabilities(iastContext)
      expect(span.addTags).to.have.been.calledOnceWithExactly({
        'manual.keep': 'true',
        '_dd.iast.json': '{"sources":[],"vulnerabilities":[' +
          '{"type":"INSECURE_HASHING","hash":1697980169,"evidence":{"value":"sha1"},' +
            '"location":{"spanId":888,"path":"/path/to/file1.js","line":1}},' +
          '{"type":"INSECURE_HASHING","hash":1726609320,"evidence":{"value":"md5"},' +
            '"location":{"spanId":1,"path":"/path/to/file2.js","line":1}},' +
          '{"type":"INSECURE_HASHING","hash":1755238473,"evidence":{"value":"md5"},' +
            '"location":{"spanId":-5,"path":"/path/to/file3.js","line":3}}]}'
      })
    })

    it('should send once vulnerability with one vulnerability', () => {
      const iastContext = { rootSpan: span }
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'sha1' }, 888,
        { path: 'filename.js', line: 88 }))
      sendVulnerabilities(iastContext)
      expect(span.addTags).to.have.been.calledOnceWithExactly({
        'manual.keep': 'true',
        '_dd.iast.json': '{"sources":[],"vulnerabilities":[{"type":"INSECURE_HASHING","hash":3410512691,' +
          '"evidence":{"value":"sha1"},"location":{"spanId":888,"path":"filename.js","line":88}}]}'
      })
    })

    it('should not send duplicated vulnerabilities', () => {
      const iastContext = { rootSpan: span }
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'sha1' }, 888,
        { path: 'filename.js', line: 88 }))
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'sha1' }, 888,
        { path: 'filename.js', line: 88 }))
      sendVulnerabilities(iastContext)
      expect(span.addTags).to.have.been.calledOnceWithExactly({
        'manual.keep': 'true',
        '_dd.iast.json': '{"sources":[],"vulnerabilities":[{"type":"INSECURE_HASHING","hash":3410512691,' +
          '"evidence":{"value":"sha1"},"location":{"spanId":888,"path":"filename.js","line":88}}]}'
      })
    })

    it('should not send duplicated vulnerabilities in multiple sends', () => {
      const iastContext = { rootSpan: span }
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'sha1' }, 888,
        { path: 'filename.js', line: 88 }))
      addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'sha1' }, 888,
        { path: 'filename.js', line: 88 }))
      sendVulnerabilities(iastContext)
      sendVulnerabilities(iastContext)
      expect(span.addTags).to.have.been.calledOnceWithExactly({
        'manual.keep': 'true',
        '_dd.iast.json': '{"sources":[],"vulnerabilities":[{"type":"INSECURE_HASHING","hash":3410512691,' +
          '"evidence":{"value":"sha1"},"location":{"spanId":888,"path":"filename.js","line":88}}]}'
      })
    })

    it('should empty the cache with more than 1000 hashes', () => {
      const iastContext = { rootSpan: span }
      const MAX = 1000
      const vulnerabilityToRepeatInTheNext = createVulnerability('INSECURE_HASHING', { value: 'sha1' }, 888,
        { path: 'filename.js', line: 0 })
      addVulnerability(iastContext, vulnerabilityToRepeatInTheNext)
      for (let i = 1; i <= MAX; i++) {
        addVulnerability(iastContext, createVulnerability('INSECURE_HASHING', { value: 'sha1' }, 888,
          { path: 'filename.js', line: i }))
      }
      sendVulnerabilities(iastContext)
      expect(span.addTags).to.have.been.calledOnce

      const nextIastContext = { rootSpan: span }
      addVulnerability(nextIastContext, vulnerabilityToRepeatInTheNext)
      sendVulnerabilities(nextIastContext)
      expect(span.addTags).to.have.been.calledTwice
    })
  })
})
