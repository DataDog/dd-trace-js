// AUTO-GENERATED by dd-compile from mysql.analysis.json
// To customize tag extraction, edit this file directly.
// Re-running dd-compile will show a diff but won't overwrite without confirmation.

'use strict'

function connectionQueryClient (ctx) {
  return {
    operation: 'query',
    resource: ctx.args?.[0],
    meta: {
      'component': 'mysql',
      'span.kind': 'client',
      'db.type': 'mysql',
      'db.name': ctx.self?.config.database || ctx.this?.config.database,
      'db.user': ctx.self?.config.user || ctx.this?.config.user,
      'db.statement': ctx.args?.[0]
    },
    metrics: {
      'db.pid': ctx.self?.threadId || ctx.this?.threadId
    }
  }
}

function poolQueryClient (ctx) {
  const config = ctx.self?.config?.connectionConfig || ctx.this?.config?.connectionConfig

  const pool = ctx.self || ctx.this
  let threadId = pool?.threadId

  if (!threadId && pool) {
    const connArrays = [
      pool._allConnections,
      pool._freeConnections,
      pool._acquiringConnections,
      pool._connectionQueue
    ]

    for (const arr of connArrays) {
      if (arr && arr.length > 0) {
        for (const conn of arr) {
          if (conn?.threadId) {
            threadId = conn.threadId
            break
          }
        }
        if (threadId) break
      }
    }
  }

  const tags = {
    'component': 'mysql',
    'span.kind': 'client',
    'db.type': 'mysql',
    'db.name': config?.database,
    'db.user': config?.user,
    'db.statement': ctx.args?.[0]
  }

  return {
    operation: 'query',
    resource: ctx.args?.[0],
    meta: tags,
    metrics: {
      'db.pid': threadId
    }
  }
}

function connectionBegintransactionClient (ctx) {
  return {
    operation: 'beginTransaction',
    resource: ctx.args?.[0],
    meta: {
      'component': 'mysql',
      'span.kind': 'client',
      'db.type': 'mysql',
      'db.name': ctx.self?.config.database || ctx.this?.config.database,
      'db.user': ctx.self?.config.user || ctx.this?.config.user,
      'db.statement': ctx.args?.[0]
    },
    metrics: {
      'db.pid': ctx.self?.threadId || ctx.this?.threadId
    }
  }
}

function connectionCommitClient (ctx) {
  return {
    operation: 'commit',
    resource: ctx.args?.[0],
    meta: {
      'component': 'mysql',
      'span.kind': 'client',
      'db.type': 'mysql',
      'db.name': ctx.self?.config?.database || ctx.this?.config?.database,
      'db.user': ctx.self?.config?.user || ctx.this?.config?.user,
    },
    metrics: {
      'db.pid': ctx.self?.threadId || ctx.this?.threadId
    }
  }
}

function connectionRollbackClient (ctx) {
  return {
    operation: 'beginTransaction',
    resource: ctx.args?.[0],
    meta: {
      'component': 'mysql',
      'span.kind': 'client',
      'db.type': 'mysql',
      'db.name': ctx.self?.config?.database || ctx.this?.config?.database,
      'db.user': ctx.self?.config?.user || ctx.this?.config?.user,
    },
    metrics: {
      'db.pid': ctx.self?.threadId || ctx.this?.threadId
    }
  }
}

module.exports = {
  'apm:mysql:connection:query': connectionQueryClient,
  'apm:mysql:pool:query': poolQueryClient,
  'apm:mysql:connection:beginTransaction': connectionBegintransactionClient,
  'apm:mysql:connection:commit': connectionCommitClient,
  'apm:mysql:connection:rollback': connectionRollbackClient
}
