(()=>{"use strict";var e,t,r,n,i,s={};s.d=(e,t)=>{for(var r in t)s.o(t,r)&&!s.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};s.r(o),s.d(o,{AllProviderEvents:()=>V,AllProviderStatus:()=>S,ClientProviderEvents:()=>V,ClientProviderStatus:()=>S,DefaultLogger:()=>G,ErrorCode:()=>O,FlagNotFoundError:()=>A,GeneralError:()=>m,GenericEventEmitter:()=>H,InvalidContextError:()=>f,LOG_LEVELS:()=>F,MapHookData:()=>v,OpenFeatureCommonAPI:()=>B,OpenFeatureError:()=>p,ParseError:()=>P,ProviderFatalError:()=>T,ProviderNotReadyError:()=>I,ProviderWrapper:()=>$,SafeLogger:()=>M,ServerProviderEvents:()=>L,ServerProviderStatus:()=>y,StandardResolutionReasons:()=>g,TargetingKeyMissingError:()=>D,TelemetryAttribute:()=>Y,TelemetryFlagMetadata:()=>x,TypeMismatchError:()=>N,createEvaluationEvent:()=>j,instantiateErrorByErrorCode:()=>C,isObject:()=>K,isString:()=>k,objectOrUndefined:()=>W,statusMatchesEvent:()=>w,stringOrUndefined:()=>U});var a=Object.defineProperty,l=Object.defineProperties,d=Object.getOwnPropertyDescriptors,E=Object.getOwnPropertySymbols,u=Object.prototype.hasOwnProperty,h=Object.prototype.propertyIsEnumerable,R=(e,t,r)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,c=(e,t)=>{for(var r in t||(t={}))u.call(t,r)&&R(e,r,t[r]);if(E)for(var r of E(t))h.call(t,r)&&R(e,r,t[r]);return e},_=(e,t,r)=>new Promise((n,i)=>{var s=e=>{try{a(r.next(e))}catch(e){i(e)}},o=e=>{try{a(r.throw(e))}catch(e){i(e)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(s,o);a((r=r.apply(e,t)).next())}),v=class{constructor(){this.data=new Map}set(e,t){this.data.set(e,t)}get(e){return this.data.get(e)}has(e){return this.data.has(e)}delete(e){return this.data.delete(e)}clear(){this.data.clear()}},g={STATIC:"STATIC",DEFAULT:"DEFAULT",TARGETING_MATCH:"TARGETING_MATCH",SPLIT:"SPLIT",CACHED:"CACHED",DISABLED:"DISABLED",UNKNOWN:"UNKNOWN",STALE:"STALE",ERROR:"ERROR"},O=((e=O||{}).PROVIDER_NOT_READY="PROVIDER_NOT_READY",e.PROVIDER_FATAL="PROVIDER_FATAL",e.FLAG_NOT_FOUND="FLAG_NOT_FOUND",e.PARSE_ERROR="PARSE_ERROR",e.TYPE_MISMATCH="TYPE_MISMATCH",e.TARGETING_KEY_MISSING="TARGETING_KEY_MISSING",e.INVALID_CONTEXT="INVALID_CONTEXT",e.GENERAL="GENERAL",e),p=class e extends Error{constructor(t,r){super(t),Object.setPrototypeOf(this,e.prototype),this.name="OpenFeatureError",this.cause=null==r?void 0:r.cause}},A=class e extends p{constructor(t,r){super(t,r),Object.setPrototypeOf(this,e.prototype),this.name="FlagNotFoundError",this.code="FLAG_NOT_FOUND"}},m=class e extends p{constructor(t,r){super(t,r),Object.setPrototypeOf(this,e.prototype),this.name="GeneralError",this.code="GENERAL"}},f=class e extends p{constructor(t,r){super(t,r),Object.setPrototypeOf(this,e.prototype),this.name="InvalidContextError",this.code="INVALID_CONTEXT"}},P=class e extends p{constructor(t,r){super(t,r),Object.setPrototypeOf(this,e.prototype),this.name="ParseError",this.code="PARSE_ERROR"}},T=class e extends p{constructor(t,r){super(t,r),Object.setPrototypeOf(this,e.prototype),this.name="ProviderFatalError",this.code="PROVIDER_FATAL"}},I=class e extends p{constructor(t,r){super(t,r),Object.setPrototypeOf(this,e.prototype),this.name="ProviderNotReadyError",this.code="PROVIDER_NOT_READY"}},D=class e extends p{constructor(t,r){super(t,r),Object.setPrototypeOf(this,e.prototype),this.name="TargetingKeyMissingError",this.code="TARGETING_KEY_MISSING"}},N=class e extends p{constructor(t,r){super(t,r),Object.setPrototypeOf(this,e.prototype),this.name="TypeMismatchError",this.code="TYPE_MISMATCH"}},C=(e,t)=>{switch(e){case"FLAG_NOT_FOUND":return new A(t);case"PARSE_ERROR":return new P(t);case"TYPE_MISMATCH":return new N(t);case"TARGETING_KEY_MISSING":return new D(t);case"INVALID_CONTEXT":return new f(t);case"PROVIDER_NOT_READY":return new I(t);case"PROVIDER_FATAL":return new T(t);default:return new m(t)}},y=((t=y||{}).NOT_READY="NOT_READY",t.READY="READY",t.ERROR="ERROR",t.STALE="STALE",t.FATAL="FATAL",t),S=((r=S||{}).NOT_READY="NOT_READY",r.READY="READY",r.ERROR="ERROR",r.STALE="STALE",r.FATAL="FATAL",r.RECONCILING="RECONCILING",r),L=((n=L||{}).Ready="PROVIDER_READY",n.Error="PROVIDER_ERROR",n.ConfigurationChanged="PROVIDER_CONFIGURATION_CHANGED",n.Stale="PROVIDER_STALE",n),V=((i=V||{}).Ready="PROVIDER_READY",i.Error="PROVIDER_ERROR",i.ConfigurationChanged="PROVIDER_CONFIGURATION_CHANGED",i.ContextChanged="PROVIDER_CONTEXT_CHANGED",i.Reconciling="PROVIDER_RECONCILING",i.Stale="PROVIDER_STALE",i),b={READY:"PROVIDER_READY",ERROR:"PROVIDER_ERROR",FATAL:"PROVIDER_ERROR",STALE:"PROVIDER_STALE",RECONCILING:"PROVIDER_RECONCILING",NOT_READY:void 0},w=(e,t)=>!t&&"PROVIDER_READY"===e||b[t]===e,G=class{error(...e){console.error(...e)}warn(...e){console.warn(...e)}info(){}debug(){}},F=["error","warn","info","debug"],M=class{constructor(e){this.fallbackLogger=new G;try{for(const t of F)if(!e[t]||"function"!=typeof e[t])throw Error(`The provided logger is missing the ${t} method.`);this.logger=e}catch(e){console.error(e),console.error("Falling back to the default logger."),this.logger=this.fallbackLogger}}error(...e){this.log("error",...e)}warn(...e){this.log("warn",...e)}info(...e){this.log("info",...e)}debug(...e){this.log("debug",...e)}log(e,...t){try{this.logger[e](...t)}catch(r){this.fallbackLogger[e](...t)}}},H=class{constructor(e){this.globalLogger=e,this._handlers={PROVIDER_CONFIGURATION_CHANGED:new WeakMap,PROVIDER_CONTEXT_CHANGED:new WeakMap,PROVIDER_READY:new WeakMap,PROVIDER_ERROR:new WeakMap,PROVIDER_STALE:new WeakMap,PROVIDER_RECONCILING:new WeakMap}}emit(e,t){this.eventEmitter.emit(e,t)}addHandler(e,t){let r=e=>_(this,null,function*(){var r;try{yield t(e)}catch(e){null==(r=this._logger)||r.error("Error running event handler:",e)}}),n=this._handlers[e].get(t);this._handlers[e].set(t,[...n||[],r]),this.eventEmitter.on(e,r)}removeHandler(e,t){let r=this._handlers[e].get(t);if(r){let t=r.pop();t&&this.eventEmitter.removeListener(e,t)}}removeAllHandlers(e){e?this.eventEmitter.removeAllListeners(e):this.eventEmitter.removeAllListeners()}getHandlers(e){return this.eventEmitter.listeners(e)}setLogger(e){return this._eventLogger=new M(e),this}get _logger(){var e,t;return null!=(t=this._eventLogger)?t:null==(e=this.globalLogger)?void 0:e.call(this)}},Y={KEY:"feature_flag.key",ERROR_CODE:"error.type",ERROR_MESSAGE:"error.message",VARIANT:"feature_flag.result.variant",VALUE:"feature_flag.result.value",CONTEXT_ID:"feature_flag.context.id",REASON:"feature_flag.result.reason",PROVIDER:"feature_flag.provider.name",FLAG_SET_ID:"feature_flag.set.id",VERSION:"feature_flag.version"},x={CONTEXT_ID:"contextId",FLAG_SET_ID:"flagSetId",VERSION:"version"};function j(e,t){var r,n,i;let s={[Y.KEY]:e.flagKey,[Y.PROVIDER]:e.providerMetadata.name,[Y.REASON]:(null!=(r=t.reason)?r:g.UNKNOWN).toLowerCase()};if(t.variant&&(s[Y.VARIANT]=t.variant),null!==t.value)if("object"!=typeof t.value)s[Y.VALUE]=t.value;else try{s[Y.VALUE]=JSON.stringify(t.value)}catch(e){}let o=null!=(n=t.flagMetadata[x.CONTEXT_ID])?n:e.context.targetingKey;o&&(s[Y.CONTEXT_ID]=o);let a=t.flagMetadata[x.FLAG_SET_ID];a&&(s[Y.FLAG_SET_ID]=a);let l=t.flagMetadata[x.VERSION];return l&&(s[Y.VERSION]=l),t.reason===g.ERROR&&(s[Y.ERROR_CODE]=(null!=(i=t.errorCode)?i:"GENERAL").toLowerCase(),t.errorMessage&&(s[Y.ERROR_MESSAGE]=t.errorMessage)),{name:"feature_flag.evaluation",attributes:s}}function k(e){return"string"==typeof e}function U(e){return k(e)?e:void 0}function K(e){return"object"==typeof e}function W(e){return K(e)?e:void 0}function X(e){return null!=e}var $=class{constructor(e,t,r){var n,i,s;this._provider=e,this._status=t,this._pendingContextChanges=0,null==(n=e.events)||n.addHandler("PROVIDER_READY",()=>{this._status=r.READY}),null==(i=e.events)||i.addHandler("PROVIDER_STALE",()=>{this._status=r.STALE}),null==(s=e.events)||s.addHandler("PROVIDER_ERROR",e=>{(null==e?void 0:e.errorCode)==="PROVIDER_FATAL"?this._status=r.FATAL:this._status=r.ERROR})}get provider(){return this._provider}set provider(e){this._provider=e}get status(){return this._status}set status(e){this._status=e}get allContextChangesSettled(){return 0===this._pendingContextChanges}incrementPendingContextChanges(){this._pendingContextChanges++}decrementPendingContextChanges(){this._pendingContextChanges--}},B=class{constructor(e){this._hooks=[],this._context={},this._logger=new G,this._clientEventHandlers=new Map,this._domainScopedContext=new Map,this._clientEvents=new Map,this._runsOn=e}addHooks(...e){return this._hooks=[...this._hooks,...e],this}getHooks(){return this._hooks}clearHooks(){return this._hooks=[],this}setLogger(e){return this._logger=new M(e),this}get providerMetadata(){return this.getProviderMetadata()}getProviderMetadata(e){return this.getProviderForClient(e).metadata}addHandler(e,t,r){[...new Map([[void 0,this._defaultProvider]]),...this._domainScopedProviders].forEach(r=>{var n;let i=r[0],s=r[1].provider;if(w(e,r[1].status))try{t({domain:i,providerName:s.metadata.name})}catch(e){null==(n=this._logger)||n.error("Error running event handler:",e)}}),this._apiEmitter.addHandler(e,t),(null==r?void 0:r.signal)&&"function"==typeof r.signal.addEventListener&&r.signal.addEventListener("abort",()=>{this.removeHandler(e,t)})}removeHandler(e,t){this._apiEmitter.removeHandler(e,t)}clearHandlers(){this._apiEmitter.removeAllHandlers()}getHandlers(e){return this._apiEmitter.getHandlers(e)}setAwaitableProvider(e,t){var r,n,i,s,o,a,l,d;let E,u=U(e),h=null!=(r=W(e))?r:W(t);if(!h)return void this._logger.debug("No provider defined, ignoring setProvider call");let R=this.getProviderForClient(u),c=h.metadata.name;if(R===h)return void this._logger.debug("Provider is already set, ignoring setProvider call");if(h.runsOn){if(h.runsOn!==this._runsOn)throw new m(`Provider '${h.metadata.name}' is intended for use on the ${h.runsOn}.`)}else this._logger.debug(`Provider '${h.metadata.name}' has not defined its intended use.`);let _=this.getAssociatedEventEmitters(u),v=new $(h,this._statusEnumType.NOT_READY,this._statusEnumType);return"function"!=typeof h.initialize||this.allProviders.includes(h)?(v.status=this._statusEnumType.READY,_.forEach(e=>{null==e||e.emit("PROVIDER_READY",{clientName:u,domain:u,providerName:c})}),null==(a=this._apiEmitter)||a.emit("PROVIDER_READY",{clientName:u,domain:u,providerName:c})):E=null==(o=null==(s=null==(i=h.initialize)?void 0:i.call(h,u&&null!=(n=this._domainScopedContext.get(u))?n:this._context))?void 0:s.then(()=>{var e;v.status=this._statusEnumType.READY,this.getAssociatedEventEmitters(u).forEach(e=>{null==e||e.emit("PROVIDER_READY",{clientName:u,domain:u,providerName:c})}),null==(e=this._apiEmitter)||e.emit("PROVIDER_READY",{clientName:u,domain:u,providerName:c})}))?void 0:o.catch(e=>{var t;throw(null==e?void 0:e.code)==="PROVIDER_FATAL"?v.status=this._statusEnumType.FATAL:v.status=this._statusEnumType.ERROR,this.getAssociatedEventEmitters(u).forEach(t=>{null==t||t.emit("PROVIDER_ERROR",{clientName:u,domain:u,providerName:c,message:null==e?void 0:e.message})}),null==(t=this._apiEmitter)||t.emit("PROVIDER_ERROR",{clientName:u,domain:u,providerName:c,message:null==e?void 0:e.message}),e}),u?this._domainScopedProviders.set(u,v):this._defaultProvider=v,this.transferListeners(R,h,u,_),this.allProviders.includes(R)||null==(d=null==(l=null==R?void 0:R.onClose)?void 0:l.call(R))||d.catch(e=>{this._logger.error(`error closing provider: ${null==e?void 0:e.message}, ${null==e?void 0:e.stack}`)}),E}getProviderForClient(e){var t,r;return e&&null!=(r=null==(t=this._domainScopedProviders.get(e))?void 0:t.provider)?r:this._defaultProvider.provider}buildAndCacheEventEmitterForClient(e){let t=this._clientEvents.get(e);if(t)return t;let r=this._createEventEmitter();this._clientEvents.set(e,r);let n=this.getProviderForClient(e);return Object.values(V).forEach(t=>{var i;return null==(i=n.events)?void 0:i.addHandler(t,i=>_(this,null,function*(){r.emit(t,l(c({},i),d({clientName:e,domain:e,providerName:n.metadata.name})))}))}),r}getUnboundEmitters(){let e=[...this._domainScopedProviders.keys()];return[...[...this._clientEvents.keys()].filter(X).filter(t=>!e.includes(t)).map(e=>this._clientEvents.get(e)),this._clientEvents.get(void 0)].filter(X)}getAssociatedEventEmitters(e){return e?[this.buildAndCacheEventEmitterForClient(e)]:this.getUnboundEmitters()}transferListeners(e,t,r,n){var i;null==(i=this._clientEventHandlers.get(r))||i.forEach(t=>{var r;return null==(r=e.events)?void 0:r.removeHandler(...t)});let s=Object.values(V).map(e=>{let i=i=>_(this,null,function*(){n.forEach(n=>{null==n||n.emit(e,l(c({},i),d({clientName:r,domain:r,providerName:t.metadata.name})))}),this._apiEmitter.emit(e,l(c({},i),d({clientName:r,domain:r,providerName:t.metadata.name})))});return[e,i]});this._clientEventHandlers.set(r,s),s.forEach(e=>{var r;return null==(r=t.events)?void 0:r.addHandler(...e)})}close(){return _(this,null,function*(){var e,t;try{yield null==(t=null==(e=this==null?void 0:this._defaultProvider.provider)?void 0:e.onClose)?void 0:t.call(e)}catch(e){this.handleShutdownError(this._defaultProvider.provider,e)}let r=Array.from(this._domainScopedProviders);yield Promise.all(r.map(e=>_(this,[e],function*([,e]){var t,r;try{yield null==(r=null==e?void 0:(t=e.provider).onClose)?void 0:r.call(t)}catch(t){this.handleShutdownError(null==e?void 0:e.provider,t)}})))})}clearProvidersAndSetDefault(e){return _(this,null,function*(){try{yield this.close()}catch(e){this._logger.error("Unable to cleanly close providers. Resetting to the default configuration.")}finally{this._domainScopedProviders.clear(),this._defaultProvider=new $(e,this._statusEnumType.NOT_READY,this._statusEnumType)}})}get allProviders(){return[...[...this._domainScopedProviders.values()].map(e=>e.provider),this._defaultProvider.provider]}handleShutdownError(e,t){this._logger.error(`Error during shutdown of provider ${e.metadata.name}: ${t}`),this._logger.error(null==t?void 0:t.stack)}};module.exports=o})();