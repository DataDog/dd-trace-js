(()=>{var e={"./spark-md5/spark-md5.js":function(e){e.exports=function(e){"use strict";var t=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function r(e,t){var r=e[0],n=e[1],i=e[2],o=e[3];r+=(n&i|~n&o)+t[0]-0x28955b88|0,o+=((r=(r<<7|r>>>25)+n|0)&n|~r&i)+t[1]-0x173848aa|0,i+=((o=(o<<12|o>>>20)+r|0)&r|~o&n)+t[2]+0x242070db|0,n+=((i=(i<<17|i>>>15)+o|0)&o|~i&r)+t[3]-0x3e423112|0,r+=((n=(n<<22|n>>>10)+i|0)&i|~n&o)+t[4]-0xa83f051|0,o+=((r=(r<<7|r>>>25)+n|0)&n|~r&i)+t[5]+0x4787c62a|0,i+=((o=(o<<12|o>>>20)+r|0)&r|~o&n)+t[6]-0x57cfb9ed|0,n+=((i=(i<<17|i>>>15)+o|0)&o|~i&r)+t[7]-0x2b96aff|0,r+=((n=(n<<22|n>>>10)+i|0)&i|~n&o)+t[8]+0x698098d8|0,o+=((r=(r<<7|r>>>25)+n|0)&n|~r&i)+t[9]-0x74bb0851|0,i+=((o=(o<<12|o>>>20)+r|0)&r|~o&n)+t[10]-42063|0,n+=((i=(i<<17|i>>>15)+o|0)&o|~i&r)+t[11]-0x76a32842|0,r+=((n=(n<<22|n>>>10)+i|0)&i|~n&o)+t[12]+0x6b901122|0,o+=((r=(r<<7|r>>>25)+n|0)&n|~r&i)+t[13]-0x2678e6d|0,i+=((o=(o<<12|o>>>20)+r|0)&r|~o&n)+t[14]-0x5986bc72|0,n+=((i=(i<<17|i>>>15)+o|0)&o|~i&r)+t[15]+0x49b40821|0,r+=((n=(n<<22|n>>>10)+i|0)&o|i&~o)+t[1]-0x9e1da9e|0,o+=((r=(r<<5|r>>>27)+n|0)&i|n&~i)+t[6]-0x3fbf4cc0|0,i+=((o=(o<<9|o>>>23)+r|0)&n|r&~n)+t[11]+0x265e5a51|0,n+=((i=(i<<14|i>>>18)+o|0)&r|o&~r)+t[0]-0x16493856|0,r+=((n=(n<<20|n>>>12)+i|0)&o|i&~o)+t[5]-0x29d0efa3|0,o+=((r=(r<<5|r>>>27)+n|0)&i|n&~i)+t[10]+0x2441453|0,i+=((o=(o<<9|o>>>23)+r|0)&n|r&~n)+t[15]-0x275e197f|0,n+=((i=(i<<14|i>>>18)+o|0)&r|o&~r)+t[4]-0x182c0438|0,r+=((n=(n<<20|n>>>12)+i|0)&o|i&~o)+t[9]+0x21e1cde6|0,o+=((r=(r<<5|r>>>27)+n|0)&i|n&~i)+t[14]-0x3cc8f82a|0,i+=((o=(o<<9|o>>>23)+r|0)&n|r&~n)+t[3]-0xb2af279|0,n+=((i=(i<<14|i>>>18)+o|0)&r|o&~r)+t[8]+0x455a14ed|0,r+=((n=(n<<20|n>>>12)+i|0)&o|i&~o)+t[13]-0x561c16fb|0,o+=((r=(r<<5|r>>>27)+n|0)&i|n&~i)+t[2]-0x3105c08|0,i+=((o=(o<<9|o>>>23)+r|0)&n|r&~n)+t[7]+0x676f02d9|0,n+=((i=(i<<14|i>>>18)+o|0)&r|o&~r)+t[12]-0x72d5b376|0,r+=((n=(n<<20|n>>>12)+i|0)^i^o)+t[5]-378558|0,o+=((r=(r<<4|r>>>28)+n|0)^n^i)+t[8]-0x788e097f|0,i+=((o=(o<<11|o>>>21)+r|0)^r^n)+t[11]+0x6d9d6122|0,n+=((i=(i<<16|i>>>16)+o|0)^o^r)+t[14]-0x21ac7f4|0,r+=((n=(n<<23|n>>>9)+i|0)^i^o)+t[1]-0x5b4115bc|0,o+=((r=(r<<4|r>>>28)+n|0)^n^i)+t[4]+0x4bdecfa9|0,i+=((o=(o<<11|o>>>21)+r|0)^r^n)+t[7]-0x944b4a0|0,n+=((i=(i<<16|i>>>16)+o|0)^o^r)+t[10]-0x41404390|0,r+=((n=(n<<23|n>>>9)+i|0)^i^o)+t[13]+0x289b7ec6|0,o+=((r=(r<<4|r>>>28)+n|0)^n^i)+t[0]-0x155ed806|0,i+=((o=(o<<11|o>>>21)+r|0)^r^n)+t[3]-0x2b10cf7b|0,n+=((i=(i<<16|i>>>16)+o|0)^o^r)+t[6]+0x4881d05|0,r+=((n=(n<<23|n>>>9)+i|0)^i^o)+t[9]-0x262b2fc7|0,o+=((r=(r<<4|r>>>28)+n|0)^n^i)+t[12]-0x1924661b|0,i+=((o=(o<<11|o>>>21)+r|0)^r^n)+t[15]+0x1fa27cf8|0,n+=((i=(i<<16|i>>>16)+o|0)^o^r)+t[2]-0x3b53a99b|0,n=(n<<23|n>>>9)+i|0,r+=(i^(n|~o))+t[0]-0xbd6ddbc|0,r=(r<<6|r>>>26)+n|0,o+=(n^(r|~i))+t[7]+0x432aff97|0,o=(o<<10|o>>>22)+r|0,i+=(r^(o|~n))+t[14]-0x546bdc59|0,i=(i<<15|i>>>17)+o|0,n+=(o^(i|~r))+t[5]-0x36c5fc7|0,n=(n<<21|n>>>11)+i|0,r+=(i^(n|~o))+t[12]+0x655b59c3|0,r=(r<<6|r>>>26)+n|0,o+=(n^(r|~i))+t[3]-0x70f3336e|0,o=(o<<10|o>>>22)+r|0,i+=(r^(o|~n))+t[10]-1051523|0,i=(i<<15|i>>>17)+o|0,n+=(o^(i|~r))+t[1]-0x7a7ba22f|0,n=(n<<21|n>>>11)+i|0,r+=(i^(n|~o))+t[8]+0x6fa87e4f|0,r=(r<<6|r>>>26)+n|0,o+=(n^(r|~i))+t[15]-0x1d31920|0,o=(o<<10|o>>>22)+r|0,i+=(r^(o|~n))+t[6]-0x5cfebcec|0,i=(i<<15|i>>>17)+o|0,n+=(o^(i|~r))+t[13]+0x4e0811a1|0,n=(n<<21|n>>>11)+i|0,r+=(i^(n|~o))+t[4]-0x8ac817e|0,r=(r<<6|r>>>26)+n|0,o+=(n^(r|~i))+t[11]-0x42c50dcb|0,o=(o<<10|o>>>22)+r|0,i+=(r^(o|~n))+t[2]+0x2ad7d2bb|0,i=(i<<15|i>>>17)+o|0,n+=(o^(i|~r))+t[9]-0x14792c6f|0,n=(n<<21|n>>>11)+i|0,e[0]=r+e[0]|0,e[1]=n+e[1]|0,e[2]=i+e[2]|0,e[3]=o+e[3]|0}function n(e){var t,r=[];for(t=0;t<64;t+=4)r[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return r}function i(e){var t,r=[];for(t=0;t<64;t+=4)r[t>>2]=e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24);return r}function o(e){var t,i,o,a,s,l,u=e.length,h=[0x67452301,-0x10325477,-0x67452302,0x10325476];for(t=64;t<=u;t+=64)r(h,n(e.substring(t-64,t)));for(i=(e=e.substring(t-64)).length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;t<i;t+=1)o[t>>2]|=e.charCodeAt(t)<<(t%4<<3);if(o[t>>2]|=128<<(t%4<<3),t>55)for(r(h,o),t=0;t<16;t+=1)o[t]=0;return s=parseInt((a=(a=8*u).toString(16).match(/(.*?)(.{0,8})$/))[2],16),l=parseInt(a[1],16)||0,o[14]=s,o[15]=l,r(h,o),h}function a(e){var r;for(r=0;r<e.length;r+=1)e[r]=function(e){var r,n="";for(r=0;r<4;r+=1)n+=t[e>>8*r+4&15]+t[e>>8*r&15];return n}(e[r]);return e.join("")}function s(e){return/[\u0080-\uFFFF]/.test(e)&&(e=unescape(encodeURIComponent(e))),e}function l(e){var t,r=[],n=e.length;for(t=0;t<n-1;t+=2)r.push(parseInt(e.substr(t,2),16));return String.fromCharCode.apply(String,r)}function u(){this.reset()}return a(o("hello")),"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||function(){function e(e,t){return(e=0|e||0)<0?Math.max(e+t,0):Math.min(e,t)}ArrayBuffer.prototype.slice=function(t,r){var n,i,o,a,s=this.byteLength,l=e(t,s),u=s;return(void 0!==r&&(u=e(r,s)),l>u)?new ArrayBuffer(0):(o=new Uint8Array(i=new ArrayBuffer(n=u-l)),a=new Uint8Array(this,l,n),o.set(a),i)}}(),u.prototype.append=function(e){return this.appendBinary(s(e)),this},u.prototype.appendBinary=function(e){this._buff+=e,this._length+=e.length;var t,i=this._buff.length;for(t=64;t<=i;t+=64)r(this._hash,n(this._buff.substring(t-64,t)));return this._buff=this._buff.substring(t-64),this},u.prototype.end=function(e){var t,r,n=this._buff,i=n.length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)o[t>>2]|=n.charCodeAt(t)<<(t%4<<3);return this._finish(o,i),r=a(this._hash),e&&(r=l(r)),this.reset(),r},u.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[0x67452301,-0x10325477,-0x67452302,0x10325476],this},u.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}},u.prototype.setState=function(e){return this._buff=e.buff,this._length=e.length,this._hash=e.hash,this},u.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},u.prototype._finish=function(e,t){var n,i,o,a=t;if(e[a>>2]|=128<<(a%4<<3),a>55)for(r(this._hash,e),a=0;a<16;a+=1)e[a]=0;i=parseInt((n=(n=8*this._length).toString(16).match(/(.*?)(.{0,8})$/))[2],16),o=parseInt(n[1],16)||0,e[14]=i,e[15]=o,r(this._hash,e)},u.hash=function(e,t){return u.hashBinary(s(e),t)},u.hashBinary=function(e,t){var r=a(o(e));return t?l(r):r},u.ArrayBuffer=function(){this.reset()},u.ArrayBuffer.prototype.append=function(e){var t,n,o,a=(t=this._buff.buffer,(n=new Uint8Array(t.byteLength+e.byteLength)).set(new Uint8Array(t)),n.set(new Uint8Array(e),t.byteLength),n),s=a.length;for(this._length+=e.byteLength,o=64;o<=s;o+=64)r(this._hash,i(a.subarray(o-64,o)));return this._buff=new Uint8Array(o-64<s?a.buffer.slice(o-64):0),this},u.ArrayBuffer.prototype.end=function(e){var t,r,n=this._buff,i=n.length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)o[t>>2]|=n[t]<<(t%4<<3);return this._finish(o,i),r=a(this._hash),e&&(r=l(r)),this.reset(),r},u.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[0x67452301,-0x10325477,-0x67452302,0x10325476],this},u.ArrayBuffer.prototype.getState=function(){var e,t=u.prototype.getState.call(this);return e=t.buff,t.buff=String.fromCharCode.apply(null,new Uint8Array(e)),t},u.ArrayBuffer.prototype.setState=function(e){return e.buff=function(e,t){var r,n=e.length,i=new ArrayBuffer(n),o=new Uint8Array(i);for(r=0;r<n;r+=1)o[r]=e.charCodeAt(r);return t?o:i}(e.buff,!0),u.prototype.setState.call(this,e)},u.ArrayBuffer.prototype.destroy=u.prototype.destroy,u.ArrayBuffer.prototype._finish=u.prototype._finish,u.ArrayBuffer.hash=function(e,t){var n=a(function(e){var t,n,o,a,s,l,u=e.length,h=[0x67452301,-0x10325477,-0x67452302,0x10325476];for(t=64;t<=u;t+=64)r(h,i(e.subarray(t-64,t)));for(n=(e=t-64<u?e.subarray(t-64):new Uint8Array(0)).length,o=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;t<n;t+=1)o[t>>2]|=e[t]<<(t%4<<3);if(o[t>>2]|=128<<(t%4<<3),t>55)for(r(h,o),t=0;t<16;t+=1)o[t]=0;return s=parseInt((a=(a=8*u).toString(16).match(/(.*?)(.{0,8})$/))[2],16),l=parseInt(a[1],16)||0,o[14]=s,o[15]=l,r(h,o),h}(new Uint8Array(e)));return t?l(n):n},u}()}},t={};function r(n){var i=t[n];if(void 0!==i)return i.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,r),o.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};(()=>{"use strict";r.r(n),r.d(n,{DatadogNodeServerProvider:()=>j});var e,t,i=r("./spark-md5/spark-md5.js"),o=r.n(i);function a(e,t=""){return new(o())().append(t).append(e).end()}function s(e){return a(JSON.stringify({flag:{key:e.flag.key},subject:{id:e.subject.id,attributes:e.subject.attributes}}))}function l(e){return a(JSON.stringify(e))}class u{constructor(e){this.delegate=e}init(){return Promise.resolve()}has(e){return this.get(e)===l(e)}get(e){return this.delegate.get(s(e))}set(e){this.delegate.set(s(e),l(e))}entries(){return this.delegate.entries()}clear(){this.delegate.clear()}}class h{constructor(e){this.capacity=e,this.cache=new Map,this.size=this.cache.size}[(Symbol.toStringTag,Symbol.iterator)](){return this.cache[Symbol.iterator]()}forEach(e){this.cache.forEach(e)}entries(){return this.cache.entries()}clear(){this.cache.clear()}delete(e){return this.cache.delete(e)}keys(){return this.cache.keys()}values(){return this.cache.values()}has(e){return this.cache.has(e)}get(e){if(!this.has(e))return;let t=this.cache.get(e);return void 0!==t&&(this.delete(e),this.cache.set(e,t)),t}set(e,t){if(0===this.capacity)return this;if(this.cache.has(e))this.cache.delete(e);else if(this.cache.size>=this.capacity){let e=this.cache.keys().next().value;e&&this.delete(e)}return this.cache.set(e,t),this}}class c extends u{constructor(e){super(new h(e))}}let d=require("@openfeature/core"),f=require("node:events");require("async_hooks");var g=Object.defineProperty,v=Object.defineProperties,p=Object.getOwnPropertyDescriptors,y=Object.getOwnPropertySymbols,b=Object.prototype.hasOwnProperty,x=Object.prototype.propertyIsEnumerable,m=(e,t,r)=>t in e?g(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,_=(e,t)=>{for(var r in t||(t={}))b.call(t,r)&&m(e,r,t[r]);if(y)for(var r of y(t))x.call(t,r)&&m(e,r,t[r]);return e},E=(e,t,r)=>new Promise((n,i)=>{var o=e=>{try{s(r.next(e))}catch(e){i(e)}},a=e=>{try{s(r.throw(e))}catch(e){i(e)}},s=e=>e.done?n(e.value):Promise.resolve(e.value).then(o,a);s((r=r.apply(e,t)).next())}),C=new class{constructor(){this.metadata={name:"No-op Provider"}}resolveBooleanEvaluation(e,t){return this.noOp(t)}resolveStringEvaluation(e,t){return this.noOp(t)}resolveNumberEvaluation(e,t){return this.noOp(t)}resolveObjectEvaluation(e,t){return this.noOp(t)}noOp(e){return Promise.resolve({value:e,reason:"No-op"})}},S=class{constructor(e,t,r,n,i,o,a,s,l={}){this.providerAccessor=e,this.providerStatusAccessor=t,this.emitterAccessor=r,this.apiContextAccessor=n,this.apiHooksAccessor=i,this.transactionContextAccessor=o,this.globalLogger=a,this.options=s,this._hooks=[],this._context=l}get metadata(){var e,t;return{name:null!=(e=this.options.domain)?e:this.options.name,domain:null!=(t=this.options.domain)?t:this.options.name,version:this.options.version,providerMetadata:this.providerAccessor().metadata}}get providerStatus(){return this.providerStatusAccessor()}addHandler(e,t,r){var n;if(this.emitterAccessor().addHandler(e,t),(0,d.statusMatchesEvent)(e,this._providerStatus))try{t({clientName:this.metadata.name,domain:this.metadata.domain,providerName:this._provider.metadata.name})}catch(e){null==(n=this._logger)||n.error("Error running event handler:",e)}(null==r?void 0:r.signal)&&"function"==typeof r.signal.addEventListener&&r.signal.addEventListener("abort",()=>{this.removeHandler(e,t)})}removeHandler(e,t){this.emitterAccessor().removeHandler(e,t)}getHandlers(e){return this.emitterAccessor().getHandlers(e)}setLogger(e){return this._clientLogger=new d.SafeLogger(e),this}setContext(e){return this._context=e,this}getContext(){return this._context}addHooks(...e){return this._hooks=[...this._hooks,...e],this}getHooks(){return this._hooks}clearHooks(){return this._hooks=[],this}getBooleanValue(e,t,r,n){return E(this,null,function*(){return(yield this.getBooleanDetails(e,t,r,n)).value})}getBooleanDetails(e,t,r,n){return this.evaluate(e,this._provider.resolveBooleanEvaluation,t,"boolean",r,n)}getStringValue(e,t,r,n){return E(this,null,function*(){return(yield this.getStringDetails(e,t,r,n)).value})}getStringDetails(e,t,r,n){return this.evaluate(e,this._provider.resolveStringEvaluation,t,"string",r,n)}getNumberValue(e,t,r,n){return E(this,null,function*(){return(yield this.getNumberDetails(e,t,r,n)).value})}getNumberDetails(e,t,r,n){return this.evaluate(e,this._provider.resolveNumberEvaluation,t,"number",r,n)}getObjectValue(e,t,r,n){return E(this,null,function*(){return(yield this.getObjectDetails(e,t,r,n)).value})}getObjectDetails(e,t,r,n){return this.evaluate(e,this._provider.resolveObjectEvaluation,t,"object",r,n)}track(e,t={},r={}){var n,i;try{if(this.shortCircuitIfNotReady(),"function"==typeof this._provider.track){let o=Object.freeze(this.mergeContexts(t));return null==(i=(n=this._provider).track)?void 0:i.call(n,e,o,r)}this._logger.debug("Provider does not support the track function; will no-op.")}catch(e){this._logger.debug("Error recording tracking event.",e)}}evaluate(e,t,r,n){return E(this,arguments,function*(e,t,r,n,i={},o={}){var a;let s,l=[...this.apiHooksAccessor(),...this.getHooks(),...o.hooks||[],...this._provider.hooks||[]],u=[...l].reverse(),h=this.mergeContexts(i),c={flagKey:e,defaultValue:r,flagValueType:n,clientMetadata:this.metadata,providerMetadata:this._provider.metadata,context:h,logger:this._logger};try{let n,i,h=yield this.beforeHooks(l,c,o);this.shortCircuitIfNotReady();let f=yield t.call(this._provider,e,r,h,this._logger),g=(n=_({},f),i={flagMetadata:Object.freeze(null!=(a=f.flagMetadata)?a:{}),flagKey:e},v(n,p(i)));if(g.errorCode){let t=(0,d.instantiateErrorByErrorCode)(g.errorCode,g.errorMessage);yield this.errorHooks(u,c,t,o),s=this.getErrorEvaluationDetails(e,r,t,g.flagMetadata)}else yield this.afterHooks(u,c,g,o),s=g}catch(t){yield this.errorHooks(u,c,t,o),s=this.getErrorEvaluationDetails(e,r,t)}return yield this.finallyHooks(u,c,s,o),s})}beforeHooks(e,t,r){return E(this,null,function*(){var n;for(let i of e)Object.freeze(t),Object.assign(t.context,_(_({},t.context),(yield null==(n=null==i?void 0:i.before)?void 0:n.call(i,t,Object.freeze(r.hookHints)))));return Object.freeze(t.context)})}afterHooks(e,t,r,n){return E(this,null,function*(){var i;for(let o of e)yield null==(i=null==o?void 0:o.after)?void 0:i.call(o,t,r,n.hookHints)})}errorHooks(e,t,r,n){return E(this,null,function*(){var i;for(let o of e)try{yield null==(i=null==o?void 0:o.error)?void 0:i.call(o,t,r,n.hookHints)}catch(e){this._logger.error(`Unhandled error during 'error' hook: ${e}`),e instanceof Error&&this._logger.error(e.stack),this._logger.error(null==e?void 0:e.stack)}})}finallyHooks(e,t,r,n){return E(this,null,function*(){var i;for(let o of e)try{yield null==(i=null==o?void 0:o.finally)?void 0:i.call(o,t,r,n.hookHints)}catch(e){this._logger.error(`Unhandled error during 'finally' hook: ${e}`),e instanceof Error&&this._logger.error(e.stack),this._logger.error(null==e?void 0:e.stack)}})}get _provider(){return this.providerAccessor()}get _providerStatus(){return this.providerStatusAccessor()}get _logger(){return this._clientLogger||this.globalLogger()}mergeContexts(e){return _(_(_(_({},this.apiContextAccessor()),this.transactionContextAccessor()),this._context),e)}shortCircuitIfNotReady(){if(this.providerStatus===d.ServerProviderStatus.NOT_READY)throw new d.ProviderNotReadyError("provider has not yet initialized");if(this.providerStatus===d.ServerProviderStatus.FATAL)throw new d.ProviderFatalError("provider is in an irrecoverable error state")}getErrorEvaluationDetails(e,t,r,n={}){let i=null==r?void 0:r.message;return{errorCode:(null==r?void 0:r.code)||d.ErrorCode.GENERAL,errorMessage:i,value:t,reason:d.StandardResolutionReasons.ERROR,flagMetadata:Object.freeze(n),flagKey:e}}},A=class extends d.GenericEventEmitter{constructor(){super(),this.eventEmitter=new f.EventEmitter({captureRejections:!0}),this.eventEmitter.on("error",e=>{var t;null==(t=this._logger)||t.error("Error running event handler:",e)})}},O=new class{getTransactionContext(){return{}}setTransactionContext(e,t,...r){t(...r)}},T=Symbol.for("@openfeature/js-sdk/api"),k=globalThis;(class e extends d.OpenFeatureCommonAPI{constructor(){super("server"),this._statusEnumType=d.ServerProviderStatus,this._apiEmitter=new A,this._defaultProvider=new d.ProviderWrapper(C,d.ServerProviderStatus.NOT_READY,this._statusEnumType),this._domainScopedProviders=new Map,this._createEventEmitter=()=>new A,this._transactionContextPropagator=O}static getInstance(){let t=k[T];if(t)return t;let r=new e;return k[T]=r,r}getProviderStatus(e){var t,r;return e&&null!=(r=null==(t=this._domainScopedProviders.get(e))?void 0:t.status)?r:this._defaultProvider.status}setProviderAndWait(e,t){return E(this,null,function*(){let r=(0,d.stringOrUndefined)(e),n=r?(0,d.objectOrUndefined)(t):(0,d.objectOrUndefined)(e);yield this.setAwaitableProvider(r,n)})}setProvider(e,t){let r=(0,d.stringOrUndefined)(e),n=r?(0,d.objectOrUndefined)(t):(0,d.objectOrUndefined)(e);return Promise.resolve(this.setAwaitableProvider(r,n)).catch(e=>{this._logger.error("Error during provider initialization:",e)}),this}getProvider(e){return this.getProviderForClient(e)}setContext(e){return this._context=e,this}getContext(){return this._context}getClient(e,t,r){var n,i;let o=(0,d.stringOrUndefined)(e);return new S(()=>this.getProviderForClient(o),()=>this.getProviderStatus(o),()=>this.buildAndCacheEventEmitterForClient(o),()=>this.getContext(),()=>this.getHooks(),()=>this.getTransactionContext(),()=>this._logger,{domain:o,version:(0,d.stringOrUndefined)(t)},null!=(i=null!=(n=(0,d.objectOrUndefined)(e))?n:(0,d.objectOrUndefined)(t))?i:(0,d.objectOrUndefined)(r))}clearProviders(){return super.clearProvidersAndSetDefault(C)}setTransactionContextPropagator(e){let t="Invalid TransactionContextPropagator, will not be set: ";return"function"!=typeof(null==e?void 0:e.getTransactionContext)?this._logger.error(`${t}: getTransactionContext is not a function.`):"function"!=typeof(null==e?void 0:e.setTransactionContext)?this._logger.error(`${t}: setTransactionContext is not a function.`):this._transactionContextPropagator=e,this}setTransactionContext(e,t,...r){this._transactionContextPropagator.setTransactionContext(e,t,...r)}getTransactionContext(){try{return this._transactionContextPropagator.getTransactionContext()}catch(e){return this._logger.error(`Error getting transaction context: ${null==e?void 0:e.message}, returning empty context.`),this._logger.error(null==e?void 0:e.stack),{}}}}).getInstance(),(e=t||(t={})).MATCHES="MATCHES",e.NOT_MATCHES="NOT_MATCHES",e.GTE="GTE",e.GT="GT",e.LTE="LTE",e.LT="LT",e.ONE_OF="ONE_OF",e.NOT_ONE_OF="NOT_ONE_OF",e.IS_NULL="IS_NULL";class w{}class P extends w{getShard(e,t){return parseInt(a(e).slice(0,8),16)%t}}function N(e,r,n,i,o,a){if(!e)return{value:i,reason:"ERROR",errorCode:d.ErrorCode.PROVIDER_NOT_READY};let{targetingKey:s,...l}=o;if(!s)return{value:i,reason:"ERROR",errorCode:d.ErrorCode.TARGETING_KEY_MISSING};let u={id:s,...l};try{return function(e,r,n,i,o,a){if(!(null==e?void 0:e.enabled))return a.debug("returning default assignment because flag is disabled",{flagKey:e?e.key:"undefined",subjectKey:n}),{value:o,reason:d.StandardResolutionReasons.DISABLED};if(!function(e,t){if("boolean"===e)return"BOOLEAN"===t;if("string"===e)return"STRING"===t;if("number"===e)return"INTEGER"===t||"NUMERIC"===t;if("object"===e)return"JSON"===t;throw Error(`Invalid expected type: ${e}`)}(r,e.variationType))return a.debug("variant value type mismatch, returning default value",{flagKey:e.key,subjectKey:n,expectedType:r,variantType:e.variationType}),{value:o,reason:d.StandardResolutionReasons.ERROR,errorCode:d.ErrorCode.TYPE_MISMATCH};let s=new Date;for(let r of e.allocations){if(r.startAt&&s<new Date(r.startAt)){a.debug("allocation before start date",{flagKey:e.key,subjectKey:n,allocationKey:r.key,startAt:r.startAt});continue}if(r.endAt&&s>=new Date(r.endAt)){a.debug("allocation after end date",{flagKey:e.key,subjectKey:n,allocationKey:r.key,endAt:r.endAt});continue}if(!function(e,r,n){return null==e||!e.length||(n.debug("evaluating rules",{rules:JSON.stringify(e),subjectAttributes:r}),e.some(e=>!(function(e,r){return r.map(r=>(function(e,r){var n,i,o;let a=e[r.attribute];if(r.operator===t.IS_NULL)return r.value?null==a:null!=a;if(null!=a)switch(r.operator){case t.GTE:case t.GT:case t.LTE:case t.LT:return n=a,i=r.value,((e,n)=>r.operator===t.GTE?e>=n:r.operator===t.GT?e>n:r.operator===t.LTE?e<=n:e<n)(Number(n),Number(i));case t.MATCHES:return new RegExp(r.value).test(String(a));case t.NOT_MATCHES:return!new RegExp(r.value).test(String(a));case t.ONE_OF:return o=a.toString(),r.value.includes(o);case t.NOT_ONE_OF:return function(e,t){return!t.includes(e)}(a.toString(),r.value)}return!1})(e,r))})(r,e.conditions).includes(!1)))}(r.rules,i,a))continue;let o=function(e,t,r,n){if(!e||0===e.length)return null;for(let i of e)if(n.debug("evaluating split sharding",{flagKey:r,subjectKey:t,variationKey:i.variationKey,shards:i.shards}),i.shards.every(e=>{let o=function(e,t,r){var n,i;let o=new P().getShard((n=e.salt,i=t,`${n}-${i}`),e.totalShards);return e.ranges.some(e=>{var t,r;return t=o,(r=e).start<=t&&t<r.end})}(e,t);return n.debug("shard match result",{flagKey:r,subjectKey:t,variationKey:i.variationKey,shard:e,matches:o}),o}))return n.debug("subject matches split",{flagKey:r,subjectKey:t,variationKey:i.variationKey}),i;return n.debug("subject matches no splits",{flagKey:r,subjectKey:t}),null}(r.splits,n,e.key,a);if(o){let t=e.variations[o.variationKey];if(t)return a.debug("evaluated a flag",{flagKey:e.key,subjectKey:n,assignment:t.value}),{value:t.value,reason:d.StandardResolutionReasons.TARGETING_MATCH,variant:t.key,flagMetadata:{allocationKey:r.key,variationType:function(e){if("BOOLEAN"===e)return"boolean";if("STRING"===e)return"string";if("INTEGER"===e||"NUMERIC"===e)return"number";if("JSON"===e)return"object";throw Error(`Cannot convert variant type to flag value type: ${e}`)}(e.variationType),doLog:!!r.doLog}}}else a.debug("no matching split found for subject",{flagKey:e.key,subjectKey:n,allocationKey:r.key})}return a.debug("returning default assignment because no allocation matched",{flagKey:e.key,subjectKey:n}),{value:o,reason:d.StandardResolutionReasons.DEFAULT}}(e.flags[n],r,s,u,i,a)}catch(e){return a.error("Error evaluating flag",{error:e}),{value:i,reason:d.StandardResolutionReasons.ERROR,errorCode:d.ErrorCode.GENERAL}}}class R{constructor(e,t){this.promise=Promise.race([new Promise((e,t)=>{this.resolve=()=>{this.cleanup(),e()},this.reject=e=>{this.cleanup(),t(e)}}),new Promise(()=>{this.timeoutId=setTimeout(()=>{t()},e)})])}async wait(){try{await this.promise}finally{this.cleanup()}}complete(){this.resolve&&this.resolve()}fail(e){this.reject&&this.reject(e)}isInitializing(){return void 0!==this.resolve}cleanup(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),this.resolve=void 0,this.reject=void 0}}class j{constructor(e){this.options=e,this.metadata={name:"datadog-node-server"},this.runsOn="server",this.hooks=[],this.events=new A,this.exposureCache=new c(5e4)}getConfiguration(){return this.configuration}setConfiguration(e){var t,r,n;let i=null==(t=this.configuration)?void 0:t.createdAt,o=!!this.configuration;if(o&&this.configuration!==e){this.events.emit(d.ServerProviderEvents.ConfigurationChanged),i!==(null==e?void 0:e.createdAt)&&(null==(r=this.exposureCache)||r.clear()),this.configuration=e;return}this.configuration=e,(null==(n=this.initController)?void 0:n.isInitializing())?this.initController.complete():o||this.events.emit(d.ServerProviderEvents.Ready)}setError(e){var t;(null==(t=this.initController)?void 0:t.isInitializing())?this.initController.fail(e):this.events.emit(d.ServerProviderEvents.Error,{error:e})}async initialize(){var e,t;if(this.configuration)return;let r=null!=(e=this.options.initializationTimeoutMs)?e:3e4;this.initController=new R(r,()=>this.setError(Error(`Initialization timeout after ${r}ms`))),await this.initController.wait(),await (null==(t=this.exposureCache)?void 0:t.init())}async resolveBooleanEvaluation(e,t,r,n){let i=N(this.configuration,"boolean",e,t,r,n);return this.handleExposure(e,r,i),i}async resolveStringEvaluation(e,t,r,n){let i=N(this.configuration,"string",e,t,r,n);return this.handleExposure(e,r,i),i}async resolveNumberEvaluation(e,t,r,n){let i=N(this.configuration,"number",e,t,r,n);return this.handleExposure(e,r,i),i}async resolveObjectEvaluation(e,t,r,n){let i=N(this.configuration,"object",e,t,r,n);return this.handleExposure(e,r,i),i}handleExposure(e,t,r){var n,i,o;let a=Date.now(),s=function(e,t){var r,n;if(!(null==(r=t.flagMetadata)?void 0:r.doLog))return;let i=null==(n=t.flagMetadata)?void 0:n.allocationKey,o=t.variant;if(!i||!o)return;let{targetingKey:a="",...s}=e;return{allocation:{key:i},flag:{key:t.flagKey},variant:{key:o},subject:{id:a,attributes:s}}}(t,{...r,flagKey:e,flagMetadata:null!=(n=r.flagMetadata)?n:{}});!s||(null==(i=this.exposureCache)?void 0:i.has(s))||this.options.exposureChannel.hasSubscribers&&(this.options.exposureChannel.publish({...s,timestamp:a}),null==(o=this.exposureCache)||o.set(s))}}})(),module.exports=n})();