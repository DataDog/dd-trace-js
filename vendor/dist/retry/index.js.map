{"version":3,"file":"retry/index.js","sources":["webpack:///./retry/index.js","webpack:///./retry/lib/retry.js","webpack:///./retry/lib/retry_operation.js"],"sourcesContent":["module.exports = require('./lib/retry');","var RetryOperation = require('./retry_operation');\n\nexports.operation = function(options) {\n  var timeouts = exports.timeouts(options);\n  return new RetryOperation(timeouts, {\n      forever: options && (options.forever || options.retries === Infinity),\n      unref: options && options.unref,\n      maxRetryTime: options && options.maxRetryTime\n  });\n};\n\nexports.timeouts = function(options) {\n  if (options instanceof Array) {\n    return [].concat(options);\n  }\n\n  var opts = {\n    retries: 10,\n    factor: 2,\n    minTimeout: 1 * 1000,\n    maxTimeout: Infinity,\n    randomize: false\n  };\n  for (var key in options) {\n    opts[key] = options[key];\n  }\n\n  if (opts.minTimeout > opts.maxTimeout) {\n    throw new Error('minTimeout is greater than maxTimeout');\n  }\n\n  var timeouts = [];\n  for (var i = 0; i < opts.retries; i++) {\n    timeouts.push(this.createTimeout(i, opts));\n  }\n\n  if (options && options.forever && !timeouts.length) {\n    timeouts.push(this.createTimeout(i, opts));\n  }\n\n  // sort the array numerically ascending\n  timeouts.sort(function(a,b) {\n    return a - b;\n  });\n\n  return timeouts;\n};\n\nexports.createTimeout = function(attempt, opts) {\n  var random = (opts.randomize)\n    ? (Math.random() + 1)\n    : 1;\n\n  var timeout = Math.round(random * Math.max(opts.minTimeout, 1) * Math.pow(opts.factor, attempt));\n  timeout = Math.min(timeout, opts.maxTimeout);\n\n  return timeout;\n};\n\nexports.wrap = function(obj, options, methods) {\n  if (options instanceof Array) {\n    methods = options;\n    options = null;\n  }\n\n  if (!methods) {\n    methods = [];\n    for (var key in obj) {\n      if (typeof obj[key] === 'function') {\n        methods.push(key);\n      }\n    }\n  }\n\n  for (var i = 0; i < methods.length; i++) {\n    var method   = methods[i];\n    var original = obj[method];\n\n    obj[method] = function retryWrapper(original) {\n      var op       = exports.operation(options);\n      var args     = Array.prototype.slice.call(arguments, 1);\n      var callback = args.pop();\n\n      args.push(function(err) {\n        if (op.retry(err)) {\n          return;\n        }\n        if (err) {\n          arguments[0] = op.mainError();\n        }\n        callback.apply(this, arguments);\n      });\n\n      op.attempt(function() {\n        original.apply(obj, args);\n      });\n    }.bind(obj, original);\n    obj[method].options = options;\n  }\n};\n","function RetryOperation(timeouts, options) {\n  // Compatibility for the old (timeouts, retryForever) signature\n  if (typeof options === 'boolean') {\n    options = { forever: options };\n  }\n\n  this._originalTimeouts = JSON.parse(JSON.stringify(timeouts));\n  this._timeouts = timeouts;\n  this._options = options || {};\n  this._maxRetryTime = options && options.maxRetryTime || Infinity;\n  this._fn = null;\n  this._errors = [];\n  this._attempts = 1;\n  this._operationTimeout = null;\n  this._operationTimeoutCb = null;\n  this._timeout = null;\n  this._operationStart = null;\n  this._timer = null;\n\n  if (this._options.forever) {\n    this._cachedTimeouts = this._timeouts.slice(0);\n  }\n}\nmodule.exports = RetryOperation;\n\nRetryOperation.prototype.reset = function() {\n  this._attempts = 1;\n  this._timeouts = this._originalTimeouts.slice(0);\n}\n\nRetryOperation.prototype.stop = function() {\n  if (this._timeout) {\n    clearTimeout(this._timeout);\n  }\n  if (this._timer) {\n    clearTimeout(this._timer);\n  }\n\n  this._timeouts       = [];\n  this._cachedTimeouts = null;\n};\n\nRetryOperation.prototype.retry = function(err) {\n  if (this._timeout) {\n    clearTimeout(this._timeout);\n  }\n\n  if (!err) {\n    return false;\n  }\n  var currentTime = new Date().getTime();\n  if (err && currentTime - this._operationStart >= this._maxRetryTime) {\n    this._errors.push(err);\n    this._errors.unshift(new Error('RetryOperation timeout occurred'));\n    return false;\n  }\n\n  this._errors.push(err);\n\n  var timeout = this._timeouts.shift();\n  if (timeout === undefined) {\n    if (this._cachedTimeouts) {\n      // retry forever, only keep last error\n      this._errors.splice(0, this._errors.length - 1);\n      timeout = this._cachedTimeouts.slice(-1);\n    } else {\n      return false;\n    }\n  }\n\n  var self = this;\n  this._timer = setTimeout(function() {\n    self._attempts++;\n\n    if (self._operationTimeoutCb) {\n      self._timeout = setTimeout(function() {\n        self._operationTimeoutCb(self._attempts);\n      }, self._operationTimeout);\n\n      if (self._options.unref) {\n          self._timeout.unref();\n      }\n    }\n\n    self._fn(self._attempts);\n  }, timeout);\n\n  if (this._options.unref) {\n      this._timer.unref();\n  }\n\n  return true;\n};\n\nRetryOperation.prototype.attempt = function(fn, timeoutOps) {\n  this._fn = fn;\n\n  if (timeoutOps) {\n    if (timeoutOps.timeout) {\n      this._operationTimeout = timeoutOps.timeout;\n    }\n    if (timeoutOps.cb) {\n      this._operationTimeoutCb = timeoutOps.cb;\n    }\n  }\n\n  var self = this;\n  if (this._operationTimeoutCb) {\n    this._timeout = setTimeout(function() {\n      self._operationTimeoutCb();\n    }, self._operationTimeout);\n  }\n\n  this._operationStart = new Date().getTime();\n\n  this._fn(this._attempts);\n};\n\nRetryOperation.prototype.try = function(fn) {\n  console.log('Using RetryOperation.try() is deprecated');\n  this.attempt(fn);\n};\n\nRetryOperation.prototype.start = function(fn) {\n  console.log('Using RetryOperation.start() is deprecated');\n  this.attempt(fn);\n};\n\nRetryOperation.prototype.start = RetryOperation.prototype.try;\n\nRetryOperation.prototype.errors = function() {\n  return this._errors;\n};\n\nRetryOperation.prototype.attempts = function() {\n  return this._attempts;\n};\n\nRetryOperation.prototype.mainError = function() {\n  if (this._errors.length === 0) {\n    return null;\n  }\n\n  var counts = {};\n  var mainError = null;\n  var mainErrorCount = 0;\n\n  for (var i = 0; i < this._errors.length; i++) {\n    var error = this._errors[i];\n    var message = error.message;\n    var count = (counts[message] || 0) + 1;\n\n    counts[message] = count;\n\n    if (count >= mainErrorCount) {\n      mainError = error;\n      mainErrorCount = count;\n    }\n  }\n\n  return mainError;\n};\n"],"names":["r","e","Array","Error","Math","o","arguments","RetryOperation","t","JSON","clearTimeout","Date","setTimeout","console","i"],"mappings":"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"}