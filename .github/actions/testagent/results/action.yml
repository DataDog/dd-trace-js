name: "Get APM Test Agent Trace Check Results"
description: "Get the APM Test Agent results from the test run."
runs:
  using: composite
  steps:
    - uses: actions/checkout@v2
    - run: |
        RESPONSE=$(curl -s -w "\n%{http_code}" -o response.txt http://127.0.0.1:9126/test/trace_check/failures)
        RESPONSE_CODE=$(echo "$RESPONSE" | awk 'END {print $NF}')
        if [[ $RESPONSE_CODE -eq 200 ]]; then
          echo "All APM Test Agent Check Traces returned successful! (HTTP 200)"
          cat response.txt
        else
          echo "APM Test Agent Check Traces failed with response code: $RESPONSE_CODE"
          echo "Failures:"
          cat response.txt
          exit 1
        fi
      shell: bash
    - uses: actions/checkout@v2
    - run: |
        RESPONSE=$(curl -s -w "\n%{http_code}" -o response.txt http://127.0.0.1:9126/test/trace_check/summary)
        RESPONSE_CODE=$(echo "$RESPONSE" | awk 'END {print $NF}')
        echo "APM Test Agent Check Traces Summary Results:"
        cat response.txt
      shell: bash
