name: Cache Forensics

on:
  pull_request:
  workflow_dispatch:
    inputs:
      cache_entries:
        description: 'JSON array of cache entries, e.g., [{"key":"abc","version":"123"},{"key":"def","version":"456"}]'
        required: true
        type: string
        default: '[{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"4793076103aa823b0a4c97942d7385d4346f77a3c30a0bad6e0f1d748becbab5"},{"key":"runner_venv-Linux-/opt/hostedtoolcache/Python/3.12.12/x64-dbe133b0a76747625e6c8139943b9dc2dbf5814e9ccf9f4a8ed5b7fa66dd2976","version":"f488f6875b536eb746450004e6f18bf74d514ad2cad78c86d6d5147ddbf9f9b0"},{"key":"playwright-browsers-oldest-dd6","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"yarn-cache-AppSec-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"c95311a28e589c62f14651d2e6001da3e2afe6e855380a412a583dabc576b960"},{"key":"Aktlxw4hnyBVd/vZJbkdxGmq8Tw=","version":"3dbcc4f8dfd5fbbab9759602b7adb19c466cf9edfc277687f97ba9efbdc86d90"},{"key":"yarn-cache-AI Guard-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"yarn-cache-Profiling-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"yarn-cache-OpenFeature-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"n71Gg/JormzoitmBpVjBCZCcL6Y=","version":"0c867ee6264758fbca938e6c6d38a3160cb478f2770da2f831e22e4c9e3720d8"},{"key":"yarn-cache-APM Capabilities-tracing-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"playwright-browsers-Linux-1.57.0","version":"b11b119dfd10565044882f81f06d3a75b1602bec6f8658ac905dd63583b2a885"},{"key":"cypress-binary-14.5.4","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"cypress-binary-10.2.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"actionlint-1.7.9-Linux-X64","version":"2c5831b0ad32de99a644bc2cdd9a58421edce007c9b47f4c1c7d25220f9d6578"},{"key":"runner_venv-Linux-/opt/hostedtoolcache/Python/3.12.12/x64-dbe133b0a76747625e6c8139943b9dc2dbf5814e9ccf9f4a8ed5b7fa66dd2976","version":"f488f6875b536eb746450004e6f18bf74d514ad2cad78c86d6d5147ddbf9f9b0"},{"key":"Aktlxw4hnyBVd/vZJbkdxGmq8Tw=","version":"3dbcc4f8dfd5fbbab9759602b7adb19c466cf9edfc277687f97ba9efbdc86d90"},{"key":"playwright-browsers-oldest-dd6","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"c95311a28e589c62f14651d2e6001da3e2afe6e855380a412a583dabc576b960"},{"key":"n71Gg/JormzoitmBpVjBCZCcL6Y=","version":"0c867ee6264758fbca938e6c6d38a3160cb478f2770da2f831e22e4c9e3720d8"},{"key":"cypress-binary-10.2.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"cypress-binary-14.5.4","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"playwright-browsers-Linux-1.57.0","version":"b11b119dfd10565044882f81f06d3a75b1602bec6f8658ac905dd63583b2a885"},{"key":"actionlint-1.7.9-Linux-X64","version":"2c5831b0ad32de99a644bc2cdd9a58421edce007c9b47f4c1c7d25220f9d6578"},{"key":"codeql-trap-1-2.23.6-javascript-a8ed0d8a2ab4e8a975c020aebdfd222740a15eba","version":"801c2033d34f5527515cf4db177503fe272d4179b9f27199bff1b2af3a149cfb"},{"key":"playwright-browsers-oldest-dd5","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"[Release Proposal]-branch-diff-3.1.1","version":"c242501c19ada3dcced7a83b074ccb8e79f816602d4125493924624b38591de2"},{"key":"cypress-binary-6.7.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"codeql-trap-1-2.23.6-javascript-083a15e32edce56badddf500ac9990e4c4437803","version":"801c2033d34f5527515cf4db177503fe272d4179b9f27199bff1b2af3a149cfb"},{"key":"yarn-cache-AppSec-windows-b0a4a0e6ff6bbebeb2d699b2043406d7263bf110034c4862eab0031664fdc09e-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"}]'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          # Use hardcoded cache entries for pull_request events, or inputs for workflow_dispatch
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CACHE_ENTRIES='[{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"4793076103aa823b0a4c97942d7385d4346f77a3c30a0bad6e0f1d748becbab5"},{"key":"runner_venv-Linux-/opt/hostedtoolcache/Python/3.12.12/x64-dbe133b0a76747625e6c8139943b9dc2dbf5814e9ccf9f4a8ed5b7fa66dd2976","version":"f488f6875b536eb746450004e6f18bf74d514ad2cad78c86d6d5147ddbf9f9b0"},{"key":"playwright-browsers-oldest-dd6","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"yarn-cache-AppSec-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"c95311a28e589c62f14651d2e6001da3e2afe6e855380a412a583dabc576b960"},{"key":"Aktlxw4hnyBVd/vZJbkdxGmq8Tw=","version":"3dbcc4f8dfd5fbbab9759602b7adb19c466cf9edfc277687f97ba9efbdc86d90"},{"key":"yarn-cache-AI Guard-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"yarn-cache-Profiling-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"yarn-cache-OpenFeature-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"n71Gg/JormzoitmBpVjBCZCcL6Y=","version":"0c867ee6264758fbca938e6c6d38a3160cb478f2770da2f831e22e4c9e3720d8"},{"key":"yarn-cache-APM Capabilities-tracing-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"playwright-browsers-Linux-1.57.0","version":"b11b119dfd10565044882f81f06d3a75b1602bec6f8658ac905dd63583b2a885"},{"key":"cypress-binary-14.5.4","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"cypress-binary-10.2.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"actionlint-1.7.9-Linux-X64","version":"2c5831b0ad32de99a644bc2cdd9a58421edce007c9b47f4c1c7d25220f9d6578"},{"key":"runner_venv-Linux-/opt/hostedtoolcache/Python/3.12.12/x64-dbe133b0a76747625e6c8139943b9dc2dbf5814e9ccf9f4a8ed5b7fa66dd2976","version":"f488f6875b536eb746450004e6f18bf74d514ad2cad78c86d6d5147ddbf9f9b0"},{"key":"Aktlxw4hnyBVd/vZJbkdxGmq8Tw=","version":"3dbcc4f8dfd5fbbab9759602b7adb19c466cf9edfc277687f97ba9efbdc86d90"},{"key":"playwright-browsers-oldest-dd6","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"c95311a28e589c62f14651d2e6001da3e2afe6e855380a412a583dabc576b960"},{"key":"n71Gg/JormzoitmBpVjBCZCcL6Y=","version":"0c867ee6264758fbca938e6c6d38a3160cb478f2770da2f831e22e4c9e3720d8"},{"key":"cypress-binary-10.2.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"cypress-binary-14.5.4","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"playwright-browsers-Linux-1.57.0","version":"b11b119dfd10565044882f81f06d3a75b1602bec6f8658ac905dd63583b2a885"},{"key":"actionlint-1.7.9-Linux-X64","version":"2c5831b0ad32de99a644bc2cdd9a58421edce007c9b47f4c1c7d25220f9d6578"},{"key":"codeql-trap-1-2.23.6-javascript-a8ed0d8a2ab4e8a975c020aebdfd222740a15eba","version":"801c2033d34f5527515cf4db177503fe272d4179b9f27199bff1b2af3a149cfb"},{"key":"playwright-browsers-oldest-dd5","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"[Release Proposal]-branch-diff-3.1.1","version":"c242501c19ada3dcced7a83b074ccb8e79f816602d4125493924624b38591de2"},{"key":"cypress-binary-6.7.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"codeql-trap-1-2.23.6-javascript-083a15e32edce56badddf500ac9990e4c4437803","version":"801c2033d34f5527515cf4db177503fe272d4179b9f27199bff1b2af3a149cfb"},{"key":"yarn-cache-AppSec-windows-b0a4a0e6ff6bbebeb2d699b2043406d7263bf110034c4862eab0031664fdc09e-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"}]'
          else
            CACHE_ENTRIES='${{ inputs.cache_entries }}'
          fi

          # Convert cache_entries to matrix format
          echo "matrix=$(echo "$CACHE_ENTRIES" | jq -c '{ include: . }')" >> $GITHUB_OUTPUT

  extract-cache:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false
      max-parallel: 10

    steps:
      - name: Setup cache directory
        run: |
          key="${{ matrix.key }}"
          version="${{ matrix.version }}"
          safe_name=$(echo "$key-$version" | tr '/' '_' | tr ':' '_')

          mkdir -p "cache-restore"
          echo "CACHE_DIR=cache-restore" >> $GITHUB_ENV
          echo "SAFE_NAME=$safe_name" >> $GITHUB_ENV

          cat > "metadata.json" <<EOF
          {
            "key": "$key",
            "version": "$version",
            "requested_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "runner_os": "$RUNNER_OS",
            "runner_arch": "$RUNNER_ARCH"
          }
          EOF

      - name: Restore cache
        id: cache-restore
        uses: actions/cache/restore@v4
        continue-on-error: true
        with:
          path: cache-restore
          key: ${{ matrix.key }}
          fail-on-cache-miss: false

      - name: Check cache status
        run: |
          if [ "${{ steps.cache-restore.outputs.cache-hit }}" == "true" ]; then
            echo "✓ Successfully restored cache: ${{ matrix.key }}"
            echo "true" > restore_status.txt
          else
            echo "✗ Cache not found: ${{ matrix.key }}"
            echo "false" > restore_status.txt
            # Create empty directory to still upload metadata
            mkdir -p cache-restore
          fi

      - name: Package cache contents
        run: |
          tar -czf "${SAFE_NAME}.tar.gz" cache-restore metadata.json restore_status.txt

          # Generate hash for this archive
          sha256sum "${SAFE_NAME}.tar.gz" > "${SAFE_NAME}.sha256"

      - name: Upload individual cache artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cache-${{ env.SAFE_NAME }}
          path: |
            ${{ env.SAFE_NAME }}.tar.gz
            ${{ env.SAFE_NAME }}.sha256
          retention-days: 30
          if-no-files-found: warn

      - name: Display summary for this cache
        if: always()
        run: |
          echo "## Cache: ${{ matrix.key }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ matrix.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Archive**: \`${SAFE_NAME}.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Restored**: ${{ steps.cache-restore.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "${SAFE_NAME}.sha256" ]; then
            echo "### SHA256" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat "${SAFE_NAME}.sha256" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
