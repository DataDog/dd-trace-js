name: Cache Forensics

on:
  pull_request:
  workflow_dispatch:
    inputs:
      cache_entries:
        description: 'JSON array of cache entries, e.g., [{"key":"abc","version":"123"},{"key":"def","version":"456"}]'
        required: true
        type: string
        default: '[{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"4793076103aa823b0a4c97942d7385d4346f77a3c30a0bad6e0f1d748becbab5"},{"key":"runner_venv-Linux-/opt/hostedtoolcache/Python/3.12.12/x64-dbe133b0a76747625e6c8139943b9dc2dbf5814e9ccf9f4a8ed5b7fa66dd2976","version":"f488f6875b536eb746450004e6f18bf74d514ad2cad78c86d6d5147ddbf9f9b0"},{"key":"playwright-browsers-oldest-dd6","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"yarn-cache-AppSec-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"c95311a28e589c62f14651d2e6001da3e2afe6e855380a412a583dabc576b960"},{"key":"Aktlxw4hnyBVd/vZJbkdxGmq8Tw=","version":"3dbcc4f8dfd5fbbab9759602b7adb19c466cf9edfc277687f97ba9efbdc86d90"},{"key":"yarn-cache-AI Guard-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"yarn-cache-Profiling-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"yarn-cache-OpenFeature-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"n71Gg/JormzoitmBpVjBCZCcL6Y=","version":"0c867ee6264758fbca938e6c6d38a3160cb478f2770da2f831e22e4c9e3720d8"},{"key":"yarn-cache-APM Capabilities-tracing-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"playwright-browsers-Linux-1.57.0","version":"b11b119dfd10565044882f81f06d3a75b1602bec6f8658ac905dd63583b2a885"},{"key":"cypress-binary-14.5.4","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"cypress-binary-10.2.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"actionlint-1.7.9-Linux-X64","version":"2c5831b0ad32de99a644bc2cdd9a58421edce007c9b47f4c1c7d25220f9d6578"},{"key":"runner_venv-Linux-/opt/hostedtoolcache/Python/3.12.12/x64-dbe133b0a76747625e6c8139943b9dc2dbf5814e9ccf9f4a8ed5b7fa66dd2976","version":"f488f6875b536eb746450004e6f18bf74d514ad2cad78c86d6d5147ddbf9f9b0"},{"key":"Aktlxw4hnyBVd/vZJbkdxGmq8Tw=","version":"3dbcc4f8dfd5fbbab9759602b7adb19c466cf9edfc277687f97ba9efbdc86d90"},{"key":"playwright-browsers-oldest-dd6","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"c95311a28e589c62f14651d2e6001da3e2afe6e855380a412a583dabc576b960"},{"key":"n71Gg/JormzoitmBpVjBCZCcL6Y=","version":"0c867ee6264758fbca938e6c6d38a3160cb478f2770da2f831e22e4c9e3720d8"},{"key":"cypress-binary-10.2.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"cypress-binary-14.5.4","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"playwright-browsers-Linux-1.57.0","version":"b11b119dfd10565044882f81f06d3a75b1602bec6f8658ac905dd63583b2a885"},{"key":"actionlint-1.7.9-Linux-X64","version":"2c5831b0ad32de99a644bc2cdd9a58421edce007c9b47f4c1c7d25220f9d6578"},{"key":"codeql-trap-1-2.23.6-javascript-a8ed0d8a2ab4e8a975c020aebdfd222740a15eba","version":"801c2033d34f5527515cf4db177503fe272d4179b9f27199bff1b2af3a149cfb"},{"key":"playwright-browsers-oldest-dd5","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"[Release Proposal]-branch-diff-3.1.1","version":"c242501c19ada3dcced7a83b074ccb8e79f816602d4125493924624b38591de2"},{"key":"cypress-binary-6.7.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"codeql-trap-1-2.23.6-javascript-083a15e32edce56badddf500ac9990e4c4437803","version":"801c2033d34f5527515cf4db177503fe272d4179b9f27199bff1b2af3a149cfb"},{"key":"yarn-cache-AppSec-windows-b0a4a0e6ff6bbebeb2d699b2043406d7263bf110034c4862eab0031664fdc09e-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"}]'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          # Use hardcoded cache entries for pull_request events, or inputs for workflow_dispatch
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CACHE_ENTRIES='[{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"4793076103aa823b0a4c97942d7385d4346f77a3c30a0bad6e0f1d748becbab5"},{"key":"runner_venv-Linux-/opt/hostedtoolcache/Python/3.12.12/x64-dbe133b0a76747625e6c8139943b9dc2dbf5814e9ccf9f4a8ed5b7fa66dd2976","version":"f488f6875b536eb746450004e6f18bf74d514ad2cad78c86d6d5147ddbf9f9b0"},{"key":"playwright-browsers-oldest-dd6","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"yarn-cache-AppSec-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"c95311a28e589c62f14651d2e6001da3e2afe6e855380a412a583dabc576b960"},{"key":"Aktlxw4hnyBVd/vZJbkdxGmq8Tw=","version":"3dbcc4f8dfd5fbbab9759602b7adb19c466cf9edfc277687f97ba9efbdc86d90"},{"key":"yarn-cache-AI Guard-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"yarn-cache-Profiling-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"yarn-cache-OpenFeature-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"n71Gg/JormzoitmBpVjBCZCcL6Y=","version":"0c867ee6264758fbca938e6c6d38a3160cb478f2770da2f831e22e4c9e3720d8"},{"key":"yarn-cache-APM Capabilities-tracing-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"playwright-browsers-Linux-1.57.0","version":"b11b119dfd10565044882f81f06d3a75b1602bec6f8658ac905dd63583b2a885"},{"key":"cypress-binary-14.5.4","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"cypress-binary-10.2.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"actionlint-1.7.9-Linux-X64","version":"2c5831b0ad32de99a644bc2cdd9a58421edce007c9b47f4c1c7d25220f9d6578"},{"key":"runner_venv-Linux-/opt/hostedtoolcache/Python/3.12.12/x64-dbe133b0a76747625e6c8139943b9dc2dbf5814e9ccf9f4a8ed5b7fa66dd2976","version":"f488f6875b536eb746450004e6f18bf74d514ad2cad78c86d6d5147ddbf9f9b0"},{"key":"Aktlxw4hnyBVd/vZJbkdxGmq8Tw=","version":"3dbcc4f8dfd5fbbab9759602b7adb19c466cf9edfc277687f97ba9efbdc86d90"},{"key":"playwright-browsers-oldest-dd6","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"c95311a28e589c62f14651d2e6001da3e2afe6e855380a412a583dabc576b960"},{"key":"n71Gg/JormzoitmBpVjBCZCcL6Y=","version":"0c867ee6264758fbca938e6c6d38a3160cb478f2770da2f831e22e4c9e3720d8"},{"key":"cypress-binary-10.2.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"cypress-binary-14.5.4","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"playwright-browsers-Linux-1.57.0","version":"b11b119dfd10565044882f81f06d3a75b1602bec6f8658ac905dd63583b2a885"},{"key":"actionlint-1.7.9-Linux-X64","version":"2c5831b0ad32de99a644bc2cdd9a58421edce007c9b47f4c1c7d25220f9d6578"},{"key":"codeql-trap-1-2.23.6-javascript-a8ed0d8a2ab4e8a975c020aebdfd222740a15eba","version":"801c2033d34f5527515cf4db177503fe272d4179b9f27199bff1b2af3a149cfb"},{"key":"playwright-browsers-oldest-dd5","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"[Release Proposal]-branch-diff-3.1.1","version":"c242501c19ada3dcced7a83b074ccb8e79f816602d4125493924624b38591de2"},{"key":"cypress-binary-6.7.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"codeql-trap-1-2.23.6-javascript-083a15e32edce56badddf500ac9990e4c4437803","version":"801c2033d34f5527515cf4db177503fe272d4179b9f27199bff1b2af3a149cfb"},{"key":"yarn-cache-AppSec-windows-b0a4a0e6ff6bbebeb2d699b2043406d7263bf110034c4862eab0031664fdc09e-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"}]'
          else
            CACHE_ENTRIES='${{ inputs.cache_entries }}'
          fi

          # Convert cache_entries to matrix format
          echo "matrix=$(echo "$CACHE_ENTRIES" | jq -c '{ include: . }')" >> $GITHUB_OUTPUT

  extract-cache:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false
      max-parallel: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Always checkout master/main to ensure cache scope access
          ref: master

      - name: Setup cache directory
        run: |
          key="${{ matrix.key }}"
          version="${{ matrix.version }}"
          # Add strategy.job-index to ensure unique names for duplicate keys
          safe_name=$(echo "$key-$version" | tr '/' '_' | tr ':' '_' | tr ' ' '_' | tr '[' '_' | tr ']' '_')
          # Add a short hash of key+version+index to ensure uniqueness
          unique_suffix=$(echo "$key-$version-${{ strategy.job-index }}" | sha256sum | cut -c1-8)
          safe_name="${safe_name}-${unique_suffix}"

          mkdir -p "cache-restore"
          echo "CACHE_DIR=cache-restore" >> $GITHUB_ENV
          echo "SAFE_NAME=$safe_name" >> $GITHUB_ENV
          echo "CACHE_KEY=$key" >> $GITHUB_ENV

          cat > "metadata.json" <<EOF
          {
            "key": "$key",
            "version": "$version",
            "job_index": "${{ strategy.job-index }}",
            "requested_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "runner_os": "$RUNNER_OS",
            "runner_arch": "$RUNNER_ARCH"
          }
          EOF

      - name: Gather cache forensics
        id: download-cache
        run: |
          set +e

          echo "=== CACHE FORENSICS REPORT ==="
          echo ""

          # Get comprehensive cache info from API
          echo "Fetching cache details from API..."
          CACHE_JSON=$(gh api /repos/${{ github.repository }}/actions/caches \
            --jq ".actions_caches[] | select(.key == \"${{ matrix.key }}\")" \
            | head -1)

          mkdir -p cache-restore

          if [ -n "$CACHE_JSON" ]; then
            echo "✓ Cache found in API"
            echo "$CACHE_JSON" | jq . | tee cache-restore/cache-api-response.json

            # Extract key fields
            CACHE_ID=$(echo "$CACHE_JSON" | jq -r '.id')
            CACHE_REF=$(echo "$CACHE_JSON" | jq -r '.ref')
            CACHE_SIZE=$(echo "$CACHE_JSON" | jq -r '.size_in_bytes')
            CACHE_VERSION=$(echo "$CACHE_JSON" | jq -r '.version')
            CREATED_AT=$(echo "$CACHE_JSON" | jq -r '.created_at')
            LAST_ACCESSED=$(echo "$CACHE_JSON" | jq -r '.last_accessed_at')

            # Find workflows that created/accessed this cache
            echo ""
            echo "Finding workflows that may have created this cache..."
            gh run list --branch master --limit 50 --json databaseId,name,createdAt,conclusion > cache-restore/recent-workflows.json

            # Create forensics report
            cat > cache-restore/FORENSICS-REPORT.md <<EOF
          # Cache Forensics Report

          ## Cache Details
          - **ID**: $CACHE_ID
          - **Key**: ${{ matrix.key }}
          - **Ref**: $CACHE_REF
          - **Size**: $(numfmt --to=iec $CACHE_SIZE 2>/dev/null || echo "$CACHE_SIZE bytes")
          - **Version Hash**: $CACHE_VERSION
          - **Created**: $CREATED_AT
          - **Last Accessed**: $LAST_ACCESSED

          ## Analysis

          ### Key Pattern Analysis
          EOF

            # Analyze the cache key to determine likely source
            KEY="${{ matrix.key }}"

            if [[ "$KEY" == *"yarn-cache"* ]]; then
              echo "- **Type**: Yarn dependency cache" >> cache-restore/FORENSICS-REPORT.md
              echo "- **Likely Source**: \`actions/setup-node\` with yarn caching" >> cache-restore/FORENSICS-REPORT.md
            elif [[ "$KEY" == *"node_modules"* ]] || [[ "$KEY" == *"npm"* ]]; then
              echo "- **Type**: NPM dependency cache" >> cache-restore/FORENSICS-REPORT.md
              echo "- **Likely Source**: \`actions/setup-node\` or \`actions/cache\`" >> cache-restore/FORENSICS-REPORT.md
            elif [[ "$KEY" == *"runner_venv"* ]] || [[ "$KEY" == *"Python"* ]]; then
              echo "- **Type**: Python virtual environment cache" >> cache-restore/FORENSICS-REPORT.md
              echo "- **Likely Source**: \`actions/setup-python\`" >> cache-restore/FORENSICS-REPORT.md
            elif [[ "$KEY" == *"playwright"* ]]; then
              echo "- **Type**: Playwright browser binaries" >> cache-restore/FORENSICS-REPORT.md
              echo "- **Likely Source**: Playwright installation step" >> cache-restore/FORENSICS-REPORT.md
            elif [[ "$KEY" == *"cypress"* ]]; then
              echo "- **Type**: Cypress binary cache" >> cache-restore/FORENSICS-REPORT.md
              echo "- **Likely Source**: Cypress installation step" >> cache-restore/FORENSICS-REPORT.md
            elif [[ "$KEY" == *"codeql"* ]]; then
              echo "- **Type**: CodeQL analysis cache" >> cache-restore/FORENSICS-REPORT.md
              echo "- **Likely Source**: CodeQL analysis workflow" >> cache-restore/FORENSICS-REPORT.md
            else
              # Check if key looks like base64
              if [[ "$KEY" =~ ^[A-Za-z0-9+/=]+$ ]] && [[ "${#KEY}" -ge 20 ]]; then
                echo "- **Type**: Unknown (base64-encoded key)" >> cache-restore/FORENSICS-REPORT.md
                echo "- **Encoded Key**: This appears to be a base64-encoded cache key" >> cache-restore/FORENSICS-REPORT.md

                # Try to decode
                DECODED=$(echo "$KEY" | base64 -d 2>/dev/null || echo "")
                if [ -n "$DECODED" ]; then
                  echo "- **Decoded**: \`$DECODED\`" >> cache-restore/FORENSICS-REPORT.md
                fi
              else
                echo "- **Type**: Unknown" >> cache-restore/FORENSICS-REPORT.md
              fi
            fi

            cat >> cache-restore/FORENSICS-REPORT.md <<EOF

          ### Version Hash
          The version hash \`$CACHE_VERSION\` is computed by GitHub Actions based on:
          - The file paths being cached
          - The runner OS and architecture
          - Other cache configuration

          ## Limitation

          ⚠️ **GitHub Actions caches cannot be downloaded without knowing the exact original path configuration.**

          The cache service requires the exact paths that were used when creating the cache. Since this cache
          was likely created by a different workflow/action, we cannot restore its actual contents.

          ## Recommended Actions

          1. **Delete the cache** if it's suspicious:
             \`\`\`bash
             gh cache delete $CACHE_ID --repo ${{ github.repository }}
             \`\`\`

          2. **Investigate the workflow** that created it by checking workflows around $CREATED_AT

          3. **Search for the cache key** in your workflow files to find where it's defined
          EOF

            echo ""
            cat cache-restore/FORENSICS-REPORT.md

            echo "cache-hit=metadata-only" >> $GITHUB_OUTPUT
          else
            echo "❌ Cache not found in API"
            echo "cache-hit=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true

      - name: Check cache status
        run: |
          if [ "${{ steps.download-cache.outputs.cache-hit }}" == "metadata-only" ]; then
            echo "✓ Cache metadata gathered: ${{ matrix.key }}"
            echo "metadata-only" > restore_status.txt
          elif [ "${{ steps.download-cache.outputs.cache-hit }}" == "false" ]; then
            echo "✗ Cache not found: ${{ matrix.key }}"
            mkdir -p cache-restore
            echo "not-found" > restore_status.txt
          fi

          # Log cache directory contents
          echo ""
          echo "=== Cache Directory Contents ==="
          if [ -d "cache-restore" ]; then
            du -sh cache-restore 2>/dev/null || echo "Empty"
            echo ""
            echo "Files:"
            find cache-restore -type f -exec ls -lh {} \; 2>/dev/null | head -20
            file_count=$(find cache-restore -type f 2>/dev/null | wc -l)
            echo ""
            echo "Total files: $file_count"
          else
            echo "cache-restore directory does not exist"
          fi

      - name: Package cache contents
        run: |
          tar -czf "${SAFE_NAME}.tar.gz" cache-restore metadata.json restore_status.txt

          # Generate hash for this archive
          sha256sum "${SAFE_NAME}.tar.gz" > "${SAFE_NAME}.sha256"

      - name: Upload individual cache artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cache-${{ env.SAFE_NAME }}
          path: |
            ${{ env.SAFE_NAME }}.tar.gz
            ${{ env.SAFE_NAME }}.sha256
          retention-days: 30
          if-no-files-found: warn

      - name: Display summary for this cache
        if: always()
        run: |
          echo "## Cache: ${{ matrix.key }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ matrix.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Archive**: \`${SAFE_NAME}.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Job Index**: ${{ strategy.job-index }}" >> $GITHUB_STEP_SUMMARY

          # Check status
          if [ "${{ steps.download-cache.outputs.cache-hit }}" == "metadata-only" ]; then
            echo "- **Status**: ⚠️ Metadata collected (actual cache contents cannot be downloaded)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.download-cache.outputs.cache-hit }}" == "false" ]; then
            echo "- **Status**: ✗ Cache not found in repository" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Show forensics report if it exists
          if [ -f "cache-restore/FORENSICS-REPORT.md" ]; then
            echo "### Forensics Report" >> $GITHUB_STEP_SUMMARY
            cat cache-restore/FORENSICS-REPORT.md >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Show available files
          if [ -d "cache-restore" ]; then
            file_count=$(find cache-restore -type f 2>/dev/null | wc -l)
            if [ "$file_count" -gt 0 ]; then
              echo "### Available Files in Archive" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              find cache-restore -type f >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi
