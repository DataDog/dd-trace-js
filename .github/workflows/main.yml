name: Cache Forensics

on:
  pull_request:
  workflow_dispatch:
    inputs:
      cache_entries:
        description: 'JSON array of cache entries, e.g., [{"key":"abc","version":"123"},{"key":"def","version":"456"}]'
        required: true
        type: string
        default: '[{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"4793076103aa823b0a4c97942d7385d4346f77a3c30a0bad6e0f1d748becbab5"},{"key":"runner_venv-Linux-/opt/hostedtoolcache/Python/3.12.12/x64-dbe133b0a76747625e6c8139943b9dc2dbf5814e9ccf9f4a8ed5b7fa66dd2976","version":"f488f6875b536eb746450004e6f18bf74d514ad2cad78c86d6d5147ddbf9f9b0"},{"key":"playwright-browsers-oldest-dd6","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"yarn-cache-AppSec-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"c95311a28e589c62f14651d2e6001da3e2afe6e855380a412a583dabc576b960"},{"key":"Aktlxw4hnyBVd/vZJbkdxGmq8Tw=","version":"3dbcc4f8dfd5fbbab9759602b7adb19c466cf9edfc277687f97ba9efbdc86d90"},{"key":"yarn-cache-AI Guard-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"yarn-cache-Profiling-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"yarn-cache-OpenFeature-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"n71Gg/JormzoitmBpVjBCZCcL6Y=","version":"0c867ee6264758fbca938e6c6d38a3160cb478f2770da2f831e22e4c9e3720d8"},{"key":"yarn-cache-APM Capabilities-tracing-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"playwright-browsers-Linux-1.57.0","version":"b11b119dfd10565044882f81f06d3a75b1602bec6f8658ac905dd63583b2a885"},{"key":"cypress-binary-14.5.4","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"cypress-binary-10.2.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"actionlint-1.7.9-Linux-X64","version":"2c5831b0ad32de99a644bc2cdd9a58421edce007c9b47f4c1c7d25220f9d6578"},{"key":"runner_venv-Linux-/opt/hostedtoolcache/Python/3.12.12/x64-dbe133b0a76747625e6c8139943b9dc2dbf5814e9ccf9f4a8ed5b7fa66dd2976","version":"f488f6875b536eb746450004e6f18bf74d514ad2cad78c86d6d5147ddbf9f9b0"},{"key":"Aktlxw4hnyBVd/vZJbkdxGmq8Tw=","version":"3dbcc4f8dfd5fbbab9759602b7adb19c466cf9edfc277687f97ba9efbdc86d90"},{"key":"playwright-browsers-oldest-dd6","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"c95311a28e589c62f14651d2e6001da3e2afe6e855380a412a583dabc576b960"},{"key":"n71Gg/JormzoitmBpVjBCZCcL6Y=","version":"0c867ee6264758fbca938e6c6d38a3160cb478f2770da2f831e22e4c9e3720d8"},{"key":"cypress-binary-10.2.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"cypress-binary-14.5.4","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"playwright-browsers-Linux-1.57.0","version":"b11b119dfd10565044882f81f06d3a75b1602bec6f8658ac905dd63583b2a885"},{"key":"actionlint-1.7.9-Linux-X64","version":"2c5831b0ad32de99a644bc2cdd9a58421edce007c9b47f4c1c7d25220f9d6578"},{"key":"codeql-trap-1-2.23.6-javascript-a8ed0d8a2ab4e8a975c020aebdfd222740a15eba","version":"801c2033d34f5527515cf4db177503fe272d4179b9f27199bff1b2af3a149cfb"},{"key":"playwright-browsers-oldest-dd5","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"[Release Proposal]-branch-diff-3.1.1","version":"c242501c19ada3dcced7a83b074ccb8e79f816602d4125493924624b38591de2"},{"key":"cypress-binary-6.7.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"codeql-trap-1-2.23.6-javascript-083a15e32edce56badddf500ac9990e4c4437803","version":"801c2033d34f5527515cf4db177503fe272d4179b9f27199bff1b2af3a149cfb"},{"key":"yarn-cache-AppSec-windows-b0a4a0e6ff6bbebeb2d699b2043406d7263bf110034c4862eab0031664fdc09e-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"}]'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          # Use hardcoded cache entries for pull_request events, or inputs for workflow_dispatch
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CACHE_ENTRIES='[{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"4793076103aa823b0a4c97942d7385d4346f77a3c30a0bad6e0f1d748becbab5"},{"key":"runner_venv-Linux-/opt/hostedtoolcache/Python/3.12.12/x64-dbe133b0a76747625e6c8139943b9dc2dbf5814e9ccf9f4a8ed5b7fa66dd2976","version":"f488f6875b536eb746450004e6f18bf74d514ad2cad78c86d6d5147ddbf9f9b0"},{"key":"playwright-browsers-oldest-dd6","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"yarn-cache-AppSec-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"c95311a28e589c62f14651d2e6001da3e2afe6e855380a412a583dabc576b960"},{"key":"Aktlxw4hnyBVd/vZJbkdxGmq8Tw=","version":"3dbcc4f8dfd5fbbab9759602b7adb19c466cf9edfc277687f97ba9efbdc86d90"},{"key":"yarn-cache-AI Guard-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"yarn-cache-Profiling-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"yarn-cache-OpenFeature-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"n71Gg/JormzoitmBpVjBCZCcL6Y=","version":"0c867ee6264758fbca938e6c6d38a3160cb478f2770da2f831e22e4c9e3720d8"},{"key":"yarn-cache-APM Capabilities-tracing-windows-d9b5f840cdc00a865cf7951df84a999743ada6664d8cdfaaee05604fadc867ba-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"},{"key":"playwright-browsers-Linux-1.57.0","version":"b11b119dfd10565044882f81f06d3a75b1602bec6f8658ac905dd63583b2a885"},{"key":"cypress-binary-14.5.4","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"cypress-binary-10.2.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"actionlint-1.7.9-Linux-X64","version":"2c5831b0ad32de99a644bc2cdd9a58421edce007c9b47f4c1c7d25220f9d6578"},{"key":"runner_venv-Linux-/opt/hostedtoolcache/Python/3.12.12/x64-dbe133b0a76747625e6c8139943b9dc2dbf5814e9ccf9f4a8ed5b7fa66dd2976","version":"f488f6875b536eb746450004e6f18bf74d514ad2cad78c86d6d5147ddbf9f9b0"},{"key":"Aktlxw4hnyBVd/vZJbkdxGmq8Tw=","version":"3dbcc4f8dfd5fbbab9759602b7adb19c466cf9edfc277687f97ba9efbdc86d90"},{"key":"playwright-browsers-oldest-dd6","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"PFxRDTsQC2CBRTRk3TMxWNYXnd0=","version":"c95311a28e589c62f14651d2e6001da3e2afe6e855380a412a583dabc576b960"},{"key":"n71Gg/JormzoitmBpVjBCZCcL6Y=","version":"0c867ee6264758fbca938e6c6d38a3160cb478f2770da2f831e22e4c9e3720d8"},{"key":"cypress-binary-10.2.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"cypress-binary-14.5.4","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"playwright-browsers-Linux-1.57.0","version":"b11b119dfd10565044882f81f06d3a75b1602bec6f8658ac905dd63583b2a885"},{"key":"actionlint-1.7.9-Linux-X64","version":"2c5831b0ad32de99a644bc2cdd9a58421edce007c9b47f4c1c7d25220f9d6578"},{"key":"codeql-trap-1-2.23.6-javascript-a8ed0d8a2ab4e8a975c020aebdfd222740a15eba","version":"801c2033d34f5527515cf4db177503fe272d4179b9f27199bff1b2af3a149cfb"},{"key":"playwright-browsers-oldest-dd5","version":"4f7514040e3a28a321a9658d8e3a51fd52c29410f6844d0d51bcb9b20ca5e3a6"},{"key":"[Release Proposal]-branch-diff-3.1.1","version":"c242501c19ada3dcced7a83b074ccb8e79f816602d4125493924624b38591de2"},{"key":"cypress-binary-6.7.0","version":"09038f5f1eb279f921ac07849ccf00ea0cadd76685c868eab628a2e3f47ef0b7"},{"key":"codeql-trap-1-2.23.6-javascript-083a15e32edce56badddf500ac9990e4c4437803","version":"801c2033d34f5527515cf4db177503fe272d4179b9f27199bff1b2af3a149cfb"},{"key":"yarn-cache-AppSec-windows-b0a4a0e6ff6bbebeb2d699b2043406d7263bf110034c4862eab0031664fdc09e-v2","version":"dfeaf94a5df020ad999e6dd827afacf94f5a2ddf5418288305ef5b91f639b181"}]'
          else
            CACHE_ENTRIES='${{ inputs.cache_entries }}'
          fi

          # Convert cache_entries to matrix format
          echo "matrix=$(echo "$CACHE_ENTRIES" | jq -c '{ include: . }')" >> $GITHUB_OUTPUT

  extract-cache:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false
      max-parallel: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Always checkout master/main to ensure cache scope access
          ref: master

      - name: Setup cache directory
        run: |
          key="${{ matrix.key }}"
          version="${{ matrix.version }}"
          # Add strategy.job-index to ensure unique names for duplicate keys
          safe_name=$(echo "$key-$version" | tr '/' '_' | tr ':' '_' | tr ' ' '_' | tr '[' '_' | tr ']' '_')
          # Add a short hash of key+version+index to ensure uniqueness
          unique_suffix=$(echo "$key-$version-${{ strategy.job-index }}" | sha256sum | cut -c1-8)
          safe_name="${safe_name}-${unique_suffix}"

          mkdir -p "cache-restore"
          echo "CACHE_DIR=cache-restore" >> $GITHUB_ENV
          echo "SAFE_NAME=$safe_name" >> $GITHUB_ENV
          echo "CACHE_KEY=$key" >> $GITHUB_ENV

          cat > "metadata.json" <<EOF
          {
            "key": "$key",
            "version": "$version",
            "job_index": "${{ strategy.job-index }}",
            "requested_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "runner_os": "$RUNNER_OS",
            "runner_arch": "$RUNNER_ARCH"
          }
          EOF

      - name: List available caches for debugging
        run: |
          echo "Current ref: $(git rev-parse --abbrev-ref HEAD)"
          echo "Current commit: $(git rev-parse HEAD)"
          echo "---"
          echo "Searching for caches matching key: ${{ matrix.key }}"
          gh cache list --limit 100 | grep -F "${{ matrix.key }}" || echo "No exact matches found in gh cache list"
          echo "---"
          echo "Checking API for detailed cache info:"
          gh api /repos/${{ github.repository }}/actions/caches --jq ".actions_caches[] | select(.key == \"${{ matrix.key }}\") | {id, key, ref, size_in_bytes}" || echo "No caches found via API"
        env:
          GH_TOKEN: ${{ github.token }}
        continue-on-error: true

      - name: Restore cache (attempt 1 - exact key)
        id: cache-restore
        uses: actions/cache/restore@v4
        continue-on-error: true
        with:
          path: cache-restore
          key: ${{ matrix.key }}
          lookup-only: false
          fail-on-cache-miss: false
          enableCrossOsArchive: true

      - name: Restore cache (attempt 2 - with restore-keys)
        if: steps.cache-restore.outputs.cache-hit != 'true'
        id: cache-restore-prefix
        uses: actions/cache/restore@v4
        continue-on-error: true
        with:
          path: cache-restore
          key: ${{ matrix.key }}-not-exists-ignore
          restore-keys: |
            ${{ matrix.key }}
          fail-on-cache-miss: false
          enableCrossOsArchive: true

      - name: Check cache status
        run: |
          restored="false"
          restore_method="none"

          if [ "${{ steps.cache-restore.outputs.cache-hit }}" == "true" ]; then
            echo "✓ Successfully restored cache: ${{ matrix.key }}"
            restored="true"
            restore_method="exact-key"
          elif [ "${{ steps.cache-restore-prefix.outputs.cache-hit }}" == "true" ]; then
            echo "✓ Successfully restored cache via prefix: ${{ matrix.key }}"
            restored="true"
            restore_method="restore-keys"
          else
            echo "✗ Cache not found: ${{ matrix.key }}"
            # Create empty directory to still upload metadata
            mkdir -p cache-restore
          fi

          echo "$restored" > restore_status.txt
          echo "Restore method: $restore_method" >> restore_status.txt

          # Log cache directory contents
          echo "Cache directory contents:"
          if [ -d "cache-restore" ]; then
            du -sh cache-restore
            find cache-restore -type f | head -20 || echo "No files found"
            file_count=$(find cache-restore -type f | wc -l)
            echo "Total files in cache: $file_count"
          else
            echo "cache-restore directory does not exist"
          fi

      - name: Package cache contents
        run: |
          tar -czf "${SAFE_NAME}.tar.gz" cache-restore metadata.json restore_status.txt

          # Generate hash for this archive
          sha256sum "${SAFE_NAME}.tar.gz" > "${SAFE_NAME}.sha256"

      - name: Upload individual cache artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cache-${{ env.SAFE_NAME }}
          path: |
            ${{ env.SAFE_NAME }}.tar.gz
            ${{ env.SAFE_NAME }}.sha256
          retention-days: 30
          if-no-files-found: warn

      - name: Display summary for this cache
        if: always()
        run: |
          echo "## Cache: ${{ matrix.key }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ matrix.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Archive**: \`${SAFE_NAME}.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Job Index**: ${{ strategy.job-index }}" >> $GITHUB_STEP_SUMMARY

          # Check which restore succeeded
          if [ "${{ steps.cache-restore.outputs.cache-hit }}" == "true" ]; then
            echo "- **Restored**: ✓ Yes (exact key)" >> $GITHUB_STEP_SUMMARY
            echo "- **Matched Key**: \`${{ steps.cache-restore.outputs.cache-matched-key }}\`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.cache-restore-prefix.outputs.cache-hit }}" == "true" ]; then
            echo "- **Restored**: ✓ Yes (via restore-keys)" >> $GITHUB_STEP_SUMMARY
            echo "- **Matched Key**: \`${{ steps.cache-restore-prefix.outputs.cache-matched-key }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Restored**: ✗ No" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Show cache contents
          if [ -d "cache-restore" ]; then
            file_count=$(find cache-restore -type f 2>/dev/null | wc -l)
            cache_size=$(du -sh cache-restore 2>/dev/null | cut -f1)
            echo "### Cache Contents" >> $GITHUB_STEP_SUMMARY
            echo "- **Files**: $file_count" >> $GITHUB_STEP_SUMMARY
            echo "- **Size**: $cache_size" >> $GITHUB_STEP_SUMMARY

            if [ "$file_count" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Sample files** (first 10):" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              find cache-restore -type f | head -10 >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "${SAFE_NAME}.sha256" ]; then
            echo "### Archive SHA256" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat "${SAFE_NAME}.sha256" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
