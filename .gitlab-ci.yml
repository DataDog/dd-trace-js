stages:
  - shared-pipeline
  - benchmarks
  - benchmarks-pr-comment
  - single-step-instrumentation-tests
  - macrobenchmarks

include:
  - remote: https://gitlab-templates.ddbuild.io/libdatadog/include-wip/one-pipeline.yml
  - local: ".gitlab/benchmarks.yml"
  - local: ".gitlab/macrobenchmarks.yml"

variables:
  # dd-trace-js has some exceptions to the default names
  AGENT_REPO_PRODUCT_NAME: auto_inject-node
  SYSTEM_TESTS_LIBRARY: nodejs

onboarding_tests_installer:
  parallel:
    matrix:
      - ONBOARDING_FILTER_WEBLOG: [test-app-nodejs,test-app-nodejs-container]

onboarding_tests_k8s_injection:
  variables:
    WEBLOG_VARIANT: sample-app
  script:
    - cd /system-tests
    - git pull # update to most recent system-tests
    - git checkout robertomonteromiguel/debug_kubernetes
    - ./build.sh -i runner # rebuild running in case there were changes
    - source venv/bin/activate
    - python --version
    - pip freeze
    - echo "Check command line - Create cluster"
    - ./debug_kind-config.sh
    - echo "Check command line - kubectl"
    - kubectl get pods
    - echo "Run tests"
    - ./run.sh K8S_LIB_INJECTION_BASIC