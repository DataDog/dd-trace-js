stages:
  - manual_images
  - package
  - deploy
  - benchmarks
  - benchmarks-pr-comment
  - single-step-instrumentation-tests

include:
  - remote: https://gitlab-templates.ddbuild.io/apm/packaging.yml
  - local: ".gitlab/benchmarks.yml"
  - local: ".gitlab/single-step-instrumentation-tests.yml"

variables:
  DOCKER_REGISTRY: registry.ddbuild.io
  CI_DOCKER_IMAGE_BASE: $DOCKER_REGISTRY/ci/dd-trace-js
  PROMOTION_TAG: current
  JS_PACKAGE_VERSION:
    description: "Version to build for .deb and .rpm. Must be already published in NPM"
  DOWNSTREAM_BRANCH:
    value: "master"
    description: "Run a specific datadog-reliability-env branch downstream"

.common: &common
  tags: [ "runner:main", "size:large" ]

build-gitlab-image:
  stage: manual_images
  rules:
    #- if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_PIPELINE_SOURCE == "push"
    #  changes:
    #    - gitlab/Dockerfile.*
    - when: manual
      allow_failure: true
  tags: [ "arch:amd64" ]
  image: $DOCKER_REGISTRY/docker:20.10.13
  script:
    - >
      docker buildx build 
      --tag $CI_DOCKER_IMAGE_BASE/gitlab:current
      --platform linux/amd64
      --push
      --file ci/gitlab/Dockerfile.gitlab
      .

package_version:
  #image: docker:git
  #extends: .common
  tags: ["arch:amd64"]
  #image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/benchmarking-platform:dd-trace-js
  image: registry.ddbuild.io/ci/dd-trace-js/gitlab:current
  #tags: ["runner:apm-k8s-tweaked-metal"]
  #image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/ci/test-infra-definitions/runner:a58cc31c
  #image: registry.ddbuild.io/images/docker:24.0.4-gbi-focal
  #image: registry.ddbuild.io/images/bazel:6-gbi

  #image: 486234852809.dkr.ecr.us-east-1.amazonaws.com/docker:20.10.13
  #tags: ["arch:amd64"]

  stage: package
  rules:
    - if: $JS_PACKAGE_VERSION
      when: on_success
    - if: '$CI_COMMIT_TAG =~ /^v.*/'
      when: on_success
    - if: $CI_COMMIT_BRANCH == 'robertomonteromiguel/add_onboarding_tests'
      when: on_success
      allow_failure: true
    - when: manual
      allow_failure: true
  script:
   - |
      echo "step 1"
      yarn install
      echo "step 2"  
      #npm pack --tag dev --provenance
      #content=`cat ./package.json | tr '\n' ' '`
      #echo "json=$content" >> $GITHUB_OUTPUT
      #npm version --no-git-tag-version ${{ fromJson(steps.pkg.outputs.json).version }}-$(git rev-parse --short HEAD)+${{ github.run_id }}.${{ github.run_attempt }}
      npm publish --tag dev --provenance --registry http://localhost:4873
      echo "Finish"



      echo "done"
      #echo "Creating volume for verdaccio storage..."
      #docker volume create verdaccio_storage;
      #echo "Run verdaccio container..."
      #docker run -d --restart unless-stopped \
      #--name verdaccio \
      #--publish 4873:4873 \
      #--mount type=volume,src=verdaccio_storage,dst=/verdaccio \
      #verdaccio/verdaccio:latest

      #if [ -z "$JS_PACKAGE_VERSION$CI_COMMIT_TAG" ]; then
      #  echo CI_JOB_ID=$CI_JOB_ID
      #  echo CI_COMMIT_REF_NAME=$CI_COMMIT_REF_NAME
      #  echo CI_COMMIT_SHA=$CI_COMMIT_SHA
      #  sh lib-injection/patch_dev_version.sh glci $CI_JOB_ID $CI_COMMIT_REF_NAME $CI_COMMIT_SHA
      #fi
  artifacts:
    reports:
      dotenv: package_version.env

package:
  extends: .package
  needs: 
    - job: package_version
      artifacts: true
  script:
    - ../.gitlab/build-deb-rpm.sh

package-arm:
  extends: .package-arm
  needs: 
    - job: package_version
      artifacts: true
  script:
    - ../.gitlab/build-deb-rpm.sh

.release-package:
  stage: deploy
  variables:
    PRODUCT_NAME: auto_inject-node
    PACKAGE_FILTER: js # product name is "node" but package name ends "js"

deploy_to_reliability_env:
  stage: deploy
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: on_success
    - when: manual
      allow_failure: true
  trigger:
    project: DataDog/apm-reliability/datadog-reliability-env
    branch: $DOWNSTREAM_BRANCH
  variables:
    UPSTREAM_BRANCH: $CI_COMMIT_REF_NAME
    UPSTREAM_PROJECT_ID: $CI_PROJECT_ID
    UPSTREAM_PROJECT_NAME: $CI_PROJECT_NAME
    UPSTREAM_COMMIT_SHA: $CI_COMMIT_SHA

deploy_to_docker_registries:
  stage: deploy
  needs: []
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v.*/ || $CI_COMMIT_TAG == "dev"'
      when: on_success
    - when: manual
      allow_failure: true
  trigger:
    project: DataDog/public-images
    branch: main
    strategy: depend
  variables:
    IMG_SOURCES: ghcr.io/datadog/dd-trace-js/dd-lib-js-init:$CI_COMMIT_TAG
    IMG_DESTINATIONS: dd-lib-js-init:$CI_COMMIT_TAG
    IMG_SIGNING: "false"
    RETRY_COUNT: 5
    RETRY_DELAY: 300

deploy_latest_to_docker_registries:
  stage: deploy
  needs: []
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v.*/'
      when: on_success
    - when: manual
      allow_failure: true
  trigger:
    project: DataDog/public-images
    branch: main
    strategy: depend
  variables:
    IMG_SOURCES: ghcr.io/datadog/dd-trace-js/dd-lib-js-init:$CI_COMMIT_TAG
    IMG_DESTINATIONS: dd-lib-js-init:latest
    IMG_SIGNING: "false"
    RETRY_COUNT: 5
    RETRY_DELAY: 300
