stages:
  - shared-pipeline
  - benchmarks
  - benchmarks-pr-comment
  - single-step-instrumentation-tests
  - macrobenchmarks

include:
  #- remote: https://gitlab-templates.ddbuild.io/libdatadog/include/one-pipeline.yml
  - remote: https://gitlab-templates.ddbuild.io/libdatadog/include-wip/robertomonteromiguel/new_ssi_gilab_ci/one-pipeline.yml
  - local: ".gitlab/benchmarks.yml"
  - local: ".gitlab/macrobenchmarks.yml"

variables:
  # dd-trace-js has some exceptions to the default names
  AGENT_REPO_PRODUCT_NAME: auto_inject-node
  SYSTEM_TESTS_LIBRARY: nodejs
  REPO_NOTIFICATION_CHANNEL: "#notifications-apm-js"

onboarding_tests_installer:
  parallel:
    matrix:
      - ONBOARDING_FILTER_WEBLOG: [test-app-nodejs]
        SCENARIO: [ SIMPLE_INSTALLER_AUTO_INJECTION ]

onboarding_tests_k8s_injection:
  parallel:
    matrix:
      - WEBLOG_VARIANT: [sample-app]
        SCENARIO: [K8S_LIB_INJECTION]
        K8S_CLUSTER_VERSION: ['7.59.0']
    
compute_ssi_tests_pipeline:
  extends: .compute_ssi_tests_pipeline
  variables:
    #SYSTEM_SCENARIO_GROUPS: "simple_onboarding,docker-ssi,lib-injection" TEST
    SYSTEM_SCENARIO_GROUPS: "simple_onboarding"

execute_ssi_tests_pipeline:
  stage: shared-pipeline
  needs: ["compute_ssi_tests_pipeline"]
  allow_failure: true
  variables:
    PARENT_PIPELINE_SOURCE: $CI_PIPELINE_SOURCE
  trigger:
    include:
      - artifact: ssi_tests_pipeline.yml
        job: compute_ssi_tests_pipeline
    strategy: depend

requirements_json_test:
  rules:
    - when: on_success
  variables:
    REQUIREMENTS_BLOCK_JSON_PATH: ".gitlab/requirements_block.json"
    REQUIREMENTS_ALLOW_JSON_PATH: ".gitlab/requirements_allow.json"

